var app=function(t){"use strict";function e(){}function i(t){return t()}function s(){return Object.create(null)}function n(t){t.forEach(i)}function r(t){return"function"==typeof t}function o(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}let h;function a(t){h=t}const l=[],c=Promise.resolve();let u=!1;const d=[],f=[],_=[];function p(t){f.push(t)}function g(){const t=new Set;do{for(;l.length;){const t=l.shift();a(t),m(t.$$)}for(;d.length;)d.shift()();for(;f.length;){const e=f.pop();t.has(e)||(e(),t.add(e))}}while(l.length);for(;_.length;)_.pop()();u=!1}function m(t){t.fragment&&(t.update(t.dirty),n(t.before_render),t.fragment.p(t.dirty,t.ctx),t.dirty=null,t.after_render.forEach(p))}function v(t,e){t.$$.dirty||(l.push(t),u||(u=!0,c.then(g)),t.$$.dirty=s()),t.$$.dirty[e]=!0}function b(t,o,l,c,u,d){const f=h;a(t);const _=o.props||{},m=t.$$={fragment:null,ctx:null,props:d,update:e,not_equal:u,bound:s(),on_mount:[],on_destroy:[],before_render:[],after_render:[],context:new Map(f?f.$$.context:[]),callbacks:s(),dirty:null};let b=!1;var y;m.ctx=l?l(t,_,(e,i)=>{m.ctx&&u(m.ctx[e],m.ctx[e]=i)&&(m.bound[e]&&m.bound[e](i),b&&v(t,e))}):_,m.update(),b=!0,n(m.before_render),m.fragment=c(m.ctx),o.target&&(o.hydrate?m.fragment.l((y=o.target,Array.from(y.childNodes))):m.fragment.c(),o.intro&&t.$$.fragment.i&&t.$$.fragment.i(),function(t,e,s){const{fragment:o,on_mount:h,on_destroy:a,after_render:l}=t.$$;o.m(e,s),p(()=>{const e=h.map(i).filter(r);a?a.push(...e):n(e),t.$$.on_mount=[]}),l.forEach(p)}(t,o.target,o.anchor),g()),a(f)}class y{$destroy(){var t,i;i=!0,(t=this).$$&&(n(t.$$.on_destroy),t.$$.fragment.d(i),t.$$.on_destroy=t.$$.fragment=null,t.$$.ctx={}),this.$destroy=e}$on(t,e){const i=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return i.push(e),()=>{const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}$set(){}}const w=2.3283064365386963e-10;class x{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*w,t=69069*t+1>>>0,this._s1=t*w,t=69069*t+1>>>0,this._s2=t*w,this._c=1,this}getUniform(){let t=2091639*this._s0+this._c*w;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2}getUniformInt(t,e){let i=Math.max(t,e),s=Math.min(t,e);return Math.floor(this.getUniform()*(i-s+1))+s}getNormal(t=0,e=1){let i,s,n;do{n=(i=2*this.getUniform()-1)*i+(s=2*this.getUniform()-1)*s}while(n>1||0==n);return t+i*Math.sqrt(-2*Math.log(n)/n)*e}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],i=t.slice();for(;i.length;){let t=i.indexOf(this.getItem(i));e.push(i.splice(t,1)[0])}return e}getWeightedValue(t){let e=0;for(let i in t)e+=t[i];let i,s=this.getUniform()*e,n=0;for(i in t)if(s<(n+=t[i]))return i;return i}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return(new x).setState(this.getState())}}var S=(new x).setSeed(Date.now());class k{getContainer(){return null}setOptions(t){this._options=t}}class T extends k{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);const e=`${t.fontStyle?`${t.fontStyle} `:""} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=e,this._updateSize(),this._ctx.font=e,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)}eventToPosition(t,e){let i=this._ctx.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}}function M(t,e=0,i=1){return t<e?e:t>i?i:t}class C extends T{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[i,s,n,r,o]=t,h=[(i+1)*this._spacingX,s*this._spacingY+this._hexSize];if(this._options.transpose&&h.reverse(),e&&(this._ctx.fillStyle=o,this._fill(h[0],h[1])),!n)return;this._ctx.fillStyle=r;let a=[].concat(n);for(let t=0;t<a.length;t++)this._ctx.fillText(a[t],h[0],Math.ceil(h[1]))}computeSize(t,e){return this._options.transpose&&(t+=e,t-=e=t-e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]}computeFontSize(t,e){this._options.transpose&&(t+=e,t-=e=t-e);let i=2*t/((this._options.width+1)*Math.sqrt(3))-1,s=e/(2+1.5*(this._options.height-1)),n=Math.min(i,s),r=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let o=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=r;let h=o/100,a=2*(n=Math.floor(n)+1)/(this._options.spacing*(1+h/Math.sqrt(3)));return Math.ceil(a)-1}_normalizedEventToPosition(t,e){let i;this._options.transpose?(t+=e,t-=e=t-e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let s=i/this._options.height;return!function(t,e){return(t%e+e)%e}(e=Math.floor(e/s),2)?t=2*Math.floor(t/(2*this._spacingX)):(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))),[t,e]}_fill(t,e){let i=this._hexSize,s=this._options.border;const n=this._ctx;n.beginPath(),this._options.transpose?(n.moveTo(t-i+s,e),n.lineTo(t-i/2+s,e+this._spacingX-s),n.lineTo(t+i/2-s,e+this._spacingX-s),n.lineTo(t+i-s,e),n.lineTo(t+i/2-s,e-this._spacingX+s),n.lineTo(t-i/2+s,e-this._spacingX+s),n.lineTo(t-i+s,e)):(n.moveTo(t,e-i+s),n.lineTo(t+this._spacingX-s,e-i/2+s),n.lineTo(t+this._spacingX-s,e+i/2-s),n.lineTo(t,e+i-s),n.lineTo(t-this._spacingX+s,e+i/2-s),n.lineTo(t-this._spacingX+s,e-i/2+s),n.lineTo(t,e-i+s)),n.fill()}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);let i,s;this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose?(i="height",s="width"):(i="width",s="height"),this._ctx.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._ctx.canvas[s]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)}}class E extends T{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(t){super.setOptions(t),this._canvasCache={}}draw(t,e){E.cache?this._drawWithCache(t):this._drawNoCache(t,e)}_drawWithCache(t){let e,[i,s,n,r,o]=t,h=""+n+r+o;if(h in this._canvasCache)e=this._canvasCache[h];else{let t=this._options.border,i=(e=document.createElement("canvas")).getContext("2d");if(e.width=this._spacingX,e.height=this._spacingY,i.fillStyle=o,i.fillRect(t,t,e.width-t,e.height-t),n){i.fillStyle=r,i.font=this._ctx.font,i.textAlign="center",i.textBaseline="middle";let t=[].concat(n);for(let e=0;e<t.length;e++)i.fillText(t[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[h]=e}this._ctx.drawImage(e,i*this._spacingX,s*this._spacingY)}_drawNoCache(t,e){let[i,s,n,r,o]=t;if(e){let t=this._options.border;this._ctx.fillStyle=o,this._ctx.fillRect(i*this._spacingX+t,s*this._spacingY+t,this._spacingX-t,this._spacingY-t)}if(!n)return;this._ctx.fillStyle=r;let h=[].concat(n);for(let t=0;t<h.length;t++)this._ctx.fillText(h[t],(i+.5)*this._spacingX,Math.ceil((s+.5)*this._spacingY))}computeSize(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}computeFontSize(t,e){let i=Math.floor(t/this._options.width),s=Math.floor(e/this._options.height),n=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let r=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=n;let o=r/100*s/i;return o>1&&(s=Math.floor(s/o)),Math.floor(s/this._options.spacing)}_normalizedEventToPosition(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY}}E.cache=!1;class z extends T{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[i,s,n,r,o]=t,h=this._options.tileWidth,a=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*h,s*a,h,a):(this._ctx.fillStyle=o,this._ctx.fillRect(i*h,s*a,h,a))),!n)return;let l=[].concat(n),c=[].concat(r),u=[].concat(o);for(let t=0;t<l.length;t++){let e=this._options.tileMap[l[t]];if(!e)throw new Error(`Char "${l[t]}" not found in tileMap`);if(this._options.tileColorize){let n=this._colorCanvas,r=n.getContext("2d");r.globalCompositeOperation="source-over",r.clearRect(0,0,h,a);let o=c[t],l=u[t];r.drawImage(this._options.tileSet,e[0],e[1],h,a,0,0,h,a),"transparent"!=o&&(r.fillStyle=o,r.globalCompositeOperation="source-atop",r.fillRect(0,0,h,a)),"transparent"!=l&&(r.fillStyle=l,r.globalCompositeOperation="destination-over",r.fillRect(0,0,h,a)),this._ctx.drawImage(n,i*h,s*a,h,a)}else this._ctx.drawImage(this._options.tileSet,e[0],e[1],h,a,i*h,s*a,h,a)}}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}}function P(t){let e,i;if(t in $)e=$[t];else{if("#"==t.charAt(0)){let i=(t.match(/[0-9a-f]/gi)||[]).map(t=>parseInt(t,16));if(3==i.length)e=i.map(t=>17*t);else{for(let t=0;t<3;t++)i[t+1]+=16*i[t],i.splice(t,1);e=i}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map(t=>parseInt(t)):[0,0,0];$[t]=e}return e.slice()}function A(t,e,i=.5){let s=t.slice();for(let n=0;n<3;n++)s[n]=Math.round(s[n]+i*(e[n]-t[n]));return s}const R=A;function W(t,e,i=.5){let s=O(t),n=O(e);for(let t=0;t<3;t++)s[t]+=i*(n[t]-s[t]);return I(s)}const X=W;function O(t){let e,i=t[0]/255,s=t[1]/255,n=t[2]/255,r=Math.max(i,s,n),o=Math.min(i,s,n),h=0,a=(r+o)/2;if(r==o)e=0;else{let t=r-o;switch(e=a>.5?t/(2-r-o):t/(r+o),r){case i:h=(s-n)/t+(s<n?6:0);break;case s:h=(n-i)/t+2;break;case n:h=(i-s)/t+4}h/=6}return[h,e,a]}function D(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}function I(t){let e=t[2];if(0==t[1])return[e=Math.round(255*e),e,e];{let i=t[1],s=e<.5?e*(1+i):e+i-e*i,n=2*e-s,r=D(n,s,t[0]+1/3),o=D(n,s,t[0]),h=D(n,s,t[0]-1/3);return[Math.round(255*r),Math.round(255*o),Math.round(255*h)]}}const $={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]};var U=Object.freeze({fromString:P,add:function(t,...e){let i=t.slice();for(let t=0;t<3;t++)for(let s=0;s<e.length;s++)i[t]+=e[s][t];return i},add_:function(t,...e){for(let i=0;i<3;i++)for(let s=0;s<e.length;s++)t[i]+=e[s][i];return t},multiply:function(t,...e){let i=t.slice();for(let t=0;t<3;t++){for(let s=0;s<e.length;s++)i[t]*=e[s][t]/255;i[t]=Math.round(i[t])}return i},multiply_:function(t,...e){for(let i=0;i<3;i++){for(let s=0;s<e.length;s++)t[i]*=e[s][i]/255;t[i]=Math.round(t[i])}return t},interpolate:A,lerp:R,interpolateHSL:W,lerpHSL:X,randomize:function(t,e){e instanceof Array||(e=Math.round(S.getNormal(0,e)));let i=t.slice();for(let t=0;t<3;t++)i[t]+=e instanceof Array?Math.round(S.getNormal(0,e[t])):e;return i},rgb2hsl:O,hsl2rgb:I,toRGB:function(t){return`rgb(${t.map(t=>M(t,0,255)).join(",")})`},toHex:function(t){return`#${t.map(t=>M(t,0,255).toString(16).padStart(2,"0")).join("")}`}});class Y extends k{static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(t){alert(t.message)}}schedule(t){requestAnimationFrame(t)}getContainer(){return this._gl.canvas}setOptions(t){super.setOptions(t),this._updateSize();let e=this._options.tileSet;e&&"complete"in e&&!e.complete?e.addEventListener("load",()=>this._updateTexture(e)):this._updateTexture(e)}draw(t,e){const i=this._gl,s=this._options;let[n,r,o,h,a]=t,l=i.canvas.height-(r+1)*s.tileHeight;if(i.scissor(n*s.tileWidth,l,s.tileWidth,s.tileHeight),e&&(s.tileColorize?i.clearColor(0,0,0,0):i.clearColor(...q(a)),i.clear(i.COLOR_BUFFER_BIT)),!o)return;let c=[].concat(o),u=[].concat(a),d=[].concat(h);i.uniform2fv(this._uniforms.targetPosRel,[n,r]);for(let t=0;t<c.length;t++){let e=this._options.tileMap[c[t]];if(!e)throw new Error(`Char "${c[t]}" not found in tileMap`);i.uniform1f(this._uniforms.colorize,s.tileColorize?1:0),i.uniform2fv(this._uniforms.tilesetPosAbs,e),s.tileColorize&&(i.uniform4fv(this._uniforms.tint,q(d[t])),i.uniform4fv(this._uniforms.bg,q(u[t]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}clear(){const t=this._gl;t.clearColor(...q(this._options.bg)),t.scissor(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}eventToPosition(t,e){let i=this._gl.canvas,s=i.getBoundingClientRect();return t-=s.left,e-=s.top,t*=i.width/s.width,e*=i.height/s.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}_initWebGL(){let t=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=t;let e=function(t,e,i){const s=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(s,e),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(s)||"");const n=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(n,i),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(n)||"");const r=t.createProgram();if(t.attachShader(r,s),t.attachShader(r,n),t.linkProgram(r),!t.getProgramParameter(r,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(r)||"");return r}(t,F,N);return t.useProgram(e),function(t){const e=new Float32Array([0,0,1,0,0,1,1,1]),i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0)}(t),L.forEach(i=>this._uniforms[i]=t.getUniformLocation(e,i)),this._program=e,t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.enable(t.SCISSOR_TEST),t}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._gl,e=this._options,i=[e.width*e.tileWidth,e.height*e.tileHeight];t.canvas.width=i[0],t.canvas.height=i[1],t.viewport(0,0,i[0],i[1]),t.uniform2fv(this._uniforms.tileSize,[e.tileWidth,e.tileHeight]),t.uniform2fv(this._uniforms.targetSize,i)}_updateTexture(t){!function(t,e){let i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)}(this._gl,t)}}const L=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],F="\n#version 300 es\n\nin vec2 tilePosRel;\nout vec2 tilesetPosPx;\n\nuniform vec2 tilesetPosAbs;\nuniform vec2 tileSize;\nuniform vec2 targetSize;\nuniform vec2 targetPosRel;\n\nvoid main() {\n\tvec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;\n\tvec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;\n\ttargetPosNdc.y *= -1.0;\n\n\tgl_Position = vec4(targetPosNdc, 0.0, 1.0);\n\ttilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;\n}".trim(),N="\n#version 300 es\nprecision highp float;\n\nin vec2 tilesetPosPx;\nout vec4 fragColor;\nuniform sampler2D image;\nuniform bool colorize;\nuniform vec4 bg;\nuniform vec4 tint;\n\nvoid main() {\n\tfragColor = vec4(0, 0, 0, 1);\n\n\tvec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);\n\n\tif (colorize) {\n\t\ttexel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;\n\t\tfragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;\n\t\tfragColor.a = texel.a + (1.0-texel.a)*bg.a;\n\t} else {\n\t\tfragColor = texel;\n\t}\n}".trim();let B={};function q(t){if(!(t in B)){let e;if("transparent"==t)e=[0,0,0,0];else if(t.indexOf("rgba")>-1){e=(t.match(/[\d.]+/g)||[]).map(Number);for(let t=0;t<3;t++)e[t]=e[t]/255}else(e=P(t).map(t=>t/255)).push(1);B[t]=e}return B[t]}function H(t){let e=P(t);return 36*Math.floor(e[0]*(6/256))+6*Math.floor(e[1]*(6/256))+1*Math.floor(e[2]*(6/256))+16}class j extends k{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],i=this.computeSize();this._offset=i.map((t,i)=>Math.floor((t-e[i])/2))}clear(){process.stdout.write(`[0;48;5;${H(this._options.bg)}m[2J`)}draw(t,e){let[i,s,n,r,o]=t,h=this._offset[0]+i,a=this._offset[1]+s,l=this.computeSize();if(h<0||h>=l[0])return;if(a<0||a>=l[1])return;if(h===this._cursor[0]&&a===this._cursor[1]||(process.stdout.write(function(t,e){return`[${e+1};${t+1}H`}(h,a)),this._cursor[0]=h,this._cursor[1]=a),e&&(n||(n=" ")),!n)return;let c=function(t,e){return`[0;38;5;${H(t)};48;5;${H(e)}m`}(r,o);c!==this._lastColor&&(process.stdout.write(c),this._lastColor=c);let u=[].concat(n);process.stdout.write(u[0]),this._cursor[0]++,this._cursor[0]>=l[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[process.stdout.columns,process.stdout.rows]}}const G=/%([bc]){([^}]*)}/g,V=0,K=1,J=2,Q=3;function Z(t,e){let i=[],s=0;t.replace(G,function(e,n,r,o){let h=t.substring(s,o);return h.length&&i.push({type:V,value:h}),i.push({type:"c"==n?J:Q,value:r.trim()}),s=o+e.length,""});let n=t.substring(s);return n.length&&i.push({type:V,value:n}),function(t,e){e||(e=1/0);let i=0,s=0,n=-1;for(;i<t.length;){let r=t[i];if(r.type==K&&(s=0,n=-1),r.type!=V){i++;continue}for(;0==s&&" "==r.value.charAt(0);)r.value=r.value.substring(1);let o=r.value.indexOf("\n");if(-1!=o){r.value=tt(t,i,o,!0);let e=r.value.split("");for(;e.length&&" "==e[e.length-1];)e.pop();r.value=e.join("")}if(r.value.length){if(s+r.value.length>e){let o=-1;for(;;){let t=r.value.indexOf(" ",o+1);if(-1==t)break;if(s+t>e)break;o=t}if(-1!=o)r.value=tt(t,i,o,!0);else if(-1!=n){let e=t[n],s=e.value.lastIndexOf(" ");e.value=tt(t,n,s,!0),i=n}else r.value=tt(t,i,e-s,!1)}else s+=r.value.length,-1!=r.value.indexOf(" ")&&(n=i);i++}else t.splice(i,1)}t.push({type:K});let r=null;for(let e=0;e<t.length;e++){let i=t[e];switch(i.type){case V:r=i;break;case K:if(r){let t=r.value.split("");for(;t.length&&" "==t[t.length-1];)t.pop();r.value=t.join("")}r=null}}return t.pop(),t}(i,e)}function tt(t,e,i,s){let n={type:K},r={type:V,value:t[e].value.substring(i+(s?1:0))};return t.splice(e+1,0,n,r),t[e].value.substring(0,i)}let et=80,it=25;const st={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},nt={hex:C,rect:E,tile:z,"tile-gl":Y,term:j},rt={width:et,height:it,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class ot{constructor(t={}){this._data={},this._dirty=!1,this._options={},t=Object.assign({},rt,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(t,e,i){let s=[this._options.bg,this._options.fg];this.draw(t,e,null,null,s[i%s.length])}clear(){this._data={},this._dirty=!0}setOptions(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){let e=nt[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(t,e){return this._backend.computeSize(t,e)}computeFontSize(t,e){return this._backend.computeFontSize(t,e)}computeTileSize(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]}eventToPosition(t){let e,i;return"touches"in t?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),this._backend.eventToPosition(e,i)}draw(t,e,i,s,n){s||(s=this._options.fg),n||(n=this._options.bg);let r=`${t},${e}`;this._data[r]=[t,e,i,s,n],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[r]=!0)}drawText(t,e,i,s){let n=null,r=null,o=t,h=e,a=1;s||(s=this._options.width-t);let l=Z(i,s);for(;l.length;){let e=l.shift();switch(e.type){case V:let i=!1,s=!1,l=!1,c=!1;for(let t=0;t<e.value.length;t++){let a=e.value.charCodeAt(t),u=e.value.charAt(t);l=a>65280&&a<65377||a>65500&&a<65512||a>65518,i=32==u.charCodeAt(0)||12288==u.charCodeAt(0),!c||l||i||o++,l&&!s&&o++,this.draw(o++,h,u,n,r),s=i,c=l}break;case J:n=e.value||null;break;case Q:r=e.value||null;break;case K:o=t,h++,a++}}return a}_tick(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty){this._backend.clear();for(let t in this._data)this._draw(t,!1)}else for(let t in this._dirty)this._draw(t,!0);this._dirty=!1}}_draw(t,e){let i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)}}ot.Rect=E,ot.Hex=C,ot.Tile=z,ot.TileGL=Y,ot.Term=j;class ht{constructor(){this._time=0,this._events=[],this._eventTimes=[]}getTime(){return this._time}clear(){return this._events=[],this._eventTimes=[],this}add(t,e){let i=this._events.length;for(let t=0;t<this._eventTimes.length;t++)if(this._eventTimes[t]>e){i=t;break}this._events.splice(i,0,t),this._eventTimes.splice(i,0,e)}get(){if(!this._events.length)return null;let t=this._eventTimes.splice(0,1)[0];if(t>0){this._time+=t;for(let e=0;e<this._eventTimes.length;e++)this._eventTimes[e]-=t}return this._events.splice(0,1)[0]}getEventTime(t){let e=this._events.indexOf(t);if(-1!=e)return this._eventTimes[e]}remove(t){let e=this._events.indexOf(t);return-1!=e&&(this._remove(e),!0)}_remove(t){this._events.splice(t,1),this._eventTimes.splice(t,1)}}class at{constructor(){this._queue=new ht,this._repeat=[],this._current=null}getTime(){return this._queue.getTime()}add(t,e){return e&&this._repeat.push(t),this}getTimeOf(t){return this._queue.getEventTime(t)}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(t){let e=this._queue.remove(t),i=this._repeat.indexOf(t);return-1!=i&&this._repeat.splice(i,1),this._current==t&&(this._current=null),e}next(){return this._current=this._queue.get(),this._current}}var lt={Simple:class extends at{add(t,e){return this._queue.add(t,0),super.add(t,e)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),super.next()}},Speed:class extends at{add(t,e,i){return this._queue.add(t,void 0!==i?i:1/t.getSpeed()),super.add(t,e)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),super.next()}},Action:class extends at{constructor(){super(),this._defaultDuration=1,this._duration=this._defaultDuration}add(t,e,i){return this._queue.add(t,i||this._defaultDuration),super.add(t,e)}clear(){return this._duration=this._defaultDuration,super.clear()}remove(t){return t==this._current&&(this._duration=this._defaultDuration),super.remove(t)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),super.next()}setDuration(t){return this._current&&(this._duration=t),this}}};class ct{constructor(t,e={}){this._lightPasses=t,this._options=Object.assign({topology:8},e)}_getCircle(t,e,i){let s,n,r,o=[];switch(this._options.topology){case 4:n=1,r=[0,1],s=[st[8][7],st[8][1],st[8][3],st[8][5]];break;case 6:s=st[6],n=1,r=[-1,1];break;case 8:s=st[4],n=2,r=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let h=t+r[0]*i,a=e+r[1]*i;for(let t=0;t<s.length;t++)for(let e=0;e<i*n;e++)o.push([h,a]),h+=s[t][0],a+=s[t][1];return o}}const ut=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]];var dt={DiscreteShadowcasting:class extends ct{compute(t,e,i,s){if(s(t,e,0,1),!this._lightPasses(t,e))return;let n,r,o,h,a,l=[];for(let c=1;c<=i;c++){let i=this._getCircle(t,e,c),u=360/i.length;for(let t=0;t<i.length;t++)if(o=i[t][0],h=i[t][1],r=(n=u*(t-.5))+u,a=!this._lightPasses(o,h),this._visibleCoords(Math.floor(n),Math.ceil(r),a,l)&&s(o,h,c,1),2==l.length&&0==l[0]&&360==l[1])return}}_visibleCoords(t,e,i,s){if(t<0){let n=this._visibleCoords(0,e,i,s),r=this._visibleCoords(360+t,360,i,s);return n||r}let n=0;for(;n<s.length&&s[n]<t;)n++;if(n==s.length)return i&&s.push(t,e),!0;let r=0;if(n%2){for(;n<s.length&&s[n]<e;)n++,r++;return 0!=r&&(i&&(r%2?s.splice(n-r,r,e):s.splice(n-r,r)),!0)}for(;n<s.length&&s[n]<e;)n++,r++;return(t!=s[n-r]||1!=r)&&(i&&(r%2?s.splice(n-r,r,t):s.splice(n-r,r,t,e)),!0)}},PreciseShadowcasting:class extends ct{compute(t,e,i,s){if(s(t,e,0,1),!this._lightPasses(t,e))return;let n,r,o,h,a,l,c=[];for(let u=1;u<=i;u++){let i=this._getCircle(t,e,u),d=i.length;for(let t=0;t<d;t++)if(n=i[t][0],r=i[t][1],h=[t?2*t-1:2*d-1,2*d],a=[2*t+1,2*d],o=!this._lightPasses(n,r),(l=this._checkVisibility(h,a,o,c))&&s(n,r,u,l),2==c.length&&0==c[0][0]&&c[1][0]==c[1][1])return}}_checkVisibility(t,e,i,s){if(t[0]>e[0])return(this._checkVisibility(t,[t[1],t[1]],i,s)+this._checkVisibility([0,1],e,i,s))/2;let n=0,r=!1;for(;n<s.length;){let e=s[n],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0!=i||n%2||(r=!0);break}n++}let o=s.length,h=!1;for(;o--;){let t=s[o],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0==i&&o%2&&(h=!0);break}}let a,l=!0;if(n==o&&(r||h)?l=!1:r&&h&&n+1==o&&o%2?l=!1:n>o&&n%2&&(l=!1),!l)return 0;let c=o-n+1;if(c%2)if(n%2){let t=s[n];a=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(n,c,e)}else{let e=s[o];a=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(n,c,t)}else{if(!(n%2))return i&&s.splice(n,c,t,e),1;{let t=s[n],e=s[o];a=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&s.splice(n,c)}}return a/((e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]))}},RecursiveShadowcasting:class extends ct{compute(t,e,i,s){s(t,e,0,1);for(let n=0;n<ut.length;n++)this._renderOctant(t,e,ut[n],i,s)}compute180(t,e,i,s,n){n(t,e,0,1);let r=(s-1+8)%8,o=(s-2+8)%8,h=(s+1+8)%8;this._renderOctant(t,e,ut[o],i,n),this._renderOctant(t,e,ut[r],i,n),this._renderOctant(t,e,ut[s],i,n),this._renderOctant(t,e,ut[h],i,n)}compute90(t,e,i,s,n){n(t,e,0,1);let r=(s-1+8)%8;this._renderOctant(t,e,ut[s],i,n),this._renderOctant(t,e,ut[r],i,n)}_renderOctant(t,e,i,s,n){this._castVisibility(t,e,1,1,0,s+1,i[0],i[1],i[2],i[3],n)}_castVisibility(t,e,i,s,n,r,o,h,a,l,c){if(!(s<n))for(let u=i;u<=r;u++){let i=-u-1,d=-u,f=!1,_=0;for(;i<=0;){let p=t+(i+=1)*o+d*h,g=e+i*a+d*l,m=(i-.5)/(d+.5),v=(i+.5)/(d-.5);if(!(v>s)){if(m<n)break;if(i*i+d*d<r*r&&c(p,g,u,1),f){if(!this._lightPasses(p,g)){_=v;continue}f=!1,s=_}else!this._lightPasses(p,g)&&u<r&&(f=!0,this._castVisibility(t,e,u+1,s,m,r,o,h,a,l,c),_=v)}}if(f)break}}}};class ft{constructor(t=et,e=it){this._width=t,this._height=e}_fillMap(t){let e=[];for(let i=0;i<this._width;i++){e.push([]);for(let s=0;s<this._height;s++)e[i].push(t)}return e}}class _t extends ft{constructor(t,e){super(t,e),this._rooms=[],this._corridors=[]}getRooms(){return this._rooms}getCorridors(){return this._corridors}}class pt{}class gt extends pt{constructor(t,e,i,s,n,r){super(),this._x1=t,this._y1=e,this._x2=i,this._y2=s,this._doors={},void 0!==n&&void 0!==r&&this.addDoor(n,r)}static createRandomAt(t,e,i,s,n){let r=n.roomWidth[0],o=n.roomWidth[1],h=S.getUniformInt(r,o);r=n.roomHeight[0],o=n.roomHeight[1];let a=S.getUniformInt(r,o);if(1==i){let i=e-Math.floor(S.getUniform()*a);return new this(t+1,i,t+h,i+a-1,t,e)}if(-1==i){let i=e-Math.floor(S.getUniform()*a);return new this(t-h,i,t-1,i+a-1,t,e)}if(1==s){let i=t-Math.floor(S.getUniform()*h);return new this(i,e+1,i+h-1,e+a,t,e)}if(-1==s){let i=t-Math.floor(S.getUniform()*h);return new this(i,e-a,i+h-1,e-1,t,e)}throw new Error("dx or dy must be 1 or -1")}static createRandomCenter(t,e,i){let s=i.roomWidth[0],n=i.roomWidth[1],r=S.getUniformInt(s,n);s=i.roomHeight[0],n=i.roomHeight[1];let o=S.getUniformInt(s,n),h=t-Math.floor(S.getUniform()*r),a=e-Math.floor(S.getUniform()*o);return new this(h,a,h+r-1,a+o-1)}static createRandom(t,e,i){let s=i.roomWidth[0],n=i.roomWidth[1],r=S.getUniformInt(s,n);s=i.roomHeight[0],n=i.roomHeight[1];let o=S.getUniformInt(s,n),h=t-r-1,a=e-o-1,l=1+Math.floor(S.getUniform()*h),c=1+Math.floor(S.getUniform()*a);return new this(l,c,l+r-1,c+o-1)}addDoor(t,e){return this._doors[t+","+e]=1,this}getDoors(t){for(let e in this._doors){let i=e.split(",");t(parseInt(i[0]),parseInt(i[1]))}return this}clearDoors(){return this._doors={},this}addDoors(t){let e=this._x1-1,i=this._x2+1,s=this._y1-1,n=this._y2+1;for(let r=e;r<=i;r++)for(let o=s;o<=n;o++)r!=e&&r!=i&&o!=s&&o!=n||t(r,o)||this.addDoor(r,o);return this}debug(){console.log("room",this._x1,this._y1,this._x2,this._y2)}isValid(t,e){let i=this._x1-1,s=this._x2+1,n=this._y1-1,r=this._y2+1;for(let o=i;o<=s;o++)for(let h=n;h<=r;h++)if(o==i||o==s||h==n||h==r){if(!t(o,h))return!1}else if(!e(o,h))return!1;return!0}create(t){let e=this._x1-1,i=this._x2+1,s=this._y1-1,n=this._y2+1,r=0;for(let o=e;o<=i;o++)for(let h=s;h<=n;h++)t(o,h,r=o+","+h in this._doors?2:o==e||o==i||h==s||h==n?1:0)}getCenter(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]}getLeft(){return this._x1}getRight(){return this._x2}getTop(){return this._y1}getBottom(){return this._y2}}class mt extends pt{constructor(t,e,i,s){super(),this._startX=t,this._startY=e,this._endX=i,this._endY=s,this._endsWithAWall=!0}static createRandomAt(t,e,i,s,n){let r=n.corridorLength[0],o=n.corridorLength[1],h=S.getUniformInt(r,o);return new this(t,e,t+i*h,e+s*h)}debug(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)}isValid(t,e){let i=this._startX,s=this._startY,n=this._endX-i,r=this._endY-s,o=1+Math.max(Math.abs(n),Math.abs(r));n&&(n/=Math.abs(n)),r&&(r/=Math.abs(r));let h=r,a=-n,l=!0;for(let c=0;c<o;c++){let u=i+c*n,d=s+c*r;if(e(u,d)||(l=!1),t(u+h,d+a)||(l=!1),t(u-h,d-a)||(l=!1),!l){o=c,this._endX=u-n,this._endY=d-r;break}}if(0==o)return!1;if(1==o&&t(this._endX+n,this._endY+r))return!1;let c=!t(this._endX+n+h,this._endY+r+a),u=!t(this._endX+n-h,this._endY+r-a);return this._endsWithAWall=t(this._endX+n,this._endY+r),!c&&!u||!this._endsWithAWall}create(t){let e=this._startX,i=this._startY,s=this._endX-e,n=this._endY-i,r=1+Math.max(Math.abs(s),Math.abs(n));s&&(s/=Math.abs(s)),n&&(n/=Math.abs(n));for(let o=0;o<r;o++){t(e+o*s,i+o*n,0)}return!0}createPriorityWalls(t){if(!this._endsWithAWall)return;let e=this._startX,i=this._startY,s=this._endX-e,n=this._endY-i;s&&(s/=Math.abs(s)),n&&(n/=Math.abs(n));let r=n,o=-s;t(this._endX+s,this._endY+n),t(this._endX+r,this._endY+o),t(this._endX-r,this._endY-o)}}const vt={room:gt,corridor:mt};class bt extends _t{constructor(t,e,i={}){super(t,e),this._options=Object.assign({roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},i),this._features={room:4,corridor:4},this._map=[],this._featureAttempts=20,this._walls={},this._dug=0,this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)}create(t){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;let e=(this._width-2)*(this._height-2);this._firstRoom();let i,s=Date.now();do{if(i=0,Date.now()-s>this._options.timeLimit)break;let t=this._findWall();if(!t)break;let e=t.split(","),n=parseInt(e[0]),r=parseInt(e[1]),o=this._getDiggingDirection(n,r);if(!o)continue;let h=0;do{if(h++,this._tryFeature(n,r,o[0],o[1])){this._removeSurroundingWalls(n,r),this._removeSurroundingWalls(n-o[0],r-o[1]);break}}while(h<this._featureAttempts);for(let t in this._walls)this._walls[t]>1&&i++}while(this._dug/e<this._options.dugPercentage||i);if(this._addDoors(),t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this._map[e][i]);return this._walls={},this._map=[],this}_digCallback(t,e,i){0==i||2==i?(this._map[t][e]=0,this._dug++):this._walls[t+","+e]=1}_isWallCallback(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]}_canBeDugCallback(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]}_priorityWallCallback(t,e){this._walls[t+","+e]=2}_firstRoom(){let t=Math.floor(this._width/2),e=Math.floor(this._height/2),i=gt.createRandomCenter(t,e,this._options);this._rooms.push(i),i.create(this._digCallback)}_findWall(){let t=[],e=[];for(let i in this._walls){2==this._walls[i]?e.push(i):t.push(i)}let i=e.length?e:t;if(!i.length)return null;let s=S.getItem(i.sort());return delete this._walls[s],s}_tryFeature(t,e,i,s){let n=S.getWeightedValue(this._features),r=vt[n].createRandomAt(t,e,i,s,this._options);return!!r.isValid(this._isWallCallback,this._canBeDugCallback)&&(r.create(this._digCallback),r instanceof gt&&this._rooms.push(r),r instanceof mt&&(r.createPriorityWalls(this._priorityWallCallback),this._corridors.push(r)),!0)}_removeSurroundingWalls(t,e){let i=st[4];for(let s=0;s<i.length;s++){let n=i[s],r=t+n[0],o=e+n[1];delete this._walls[r+","+o],r=t+2*n[0],o=e+2*n[1],delete this._walls[r+","+o]}}_getDiggingDirection(t,e){if(t<=0||e<=0||t>=this._width-1||e>=this._height-1)return null;let i=null,s=st[4];for(let n=0;n<s.length;n++){let r=s[n],o=t+r[0],h=e+r[1];if(!this._map[o][h]){if(i)return null;i=r}}return i?[-i[0],-i[1]]:null}_addDoors(){let t=this._map;function e(e,i){return 1==t[e][i]}for(let t=0;t<this._rooms.length;t++){let i=this._rooms[t];i.clearDoors(),i.addDoors(e)}}}class yt{constructor(t,e,i,s={}){this._toX=t,this._toY=e,this._passableCallback=i,this._options=Object.assign({topology:8},s),this._dirs=st[this._options.topology],8==this._options.topology&&(this._dirs=[this._dirs[0],this._dirs[2],this._dirs[4],this._dirs[6],this._dirs[1],this._dirs[3],this._dirs[5],this._dirs[7]])}_getNeighbors(t,e){let i=[];for(let s=0;s<this._dirs.length;s++){let n=this._dirs[s],r=t+n[0],o=e+n[1];this._passableCallback(r,o)&&i.push([r,o])}return i}}var wt={Dijkstra:class extends yt{constructor(t,e,i,s){super(t,e,i,s),this._computed={},this._todo=[],this._add(t,e,null)}compute(t,e,i){let s=t+","+e;if(s in this._computed||this._compute(t,e),!(s in this._computed))return;let n=this._computed[s];for(;n;)i(n.x,n.y),n=n.prev}_compute(t,e){for(;this._todo.length;){let i=this._todo.shift();if(i.x==t&&i.y==e)return;let s=this._getNeighbors(i.x,i.y);for(let t=0;t<s.length;t++){let e=s[t],n=e[0],r=e[1];n+","+r in this._computed||this._add(n,r,i)}}}_add(t,e,i){let s={x:t,y:e,prev:i};this._computed[t+","+e]=s,this._todo.push(s)}},AStar:class extends yt{constructor(t,e,i,s={}){super(t,e,i,s),this._todo=[],this._done={}}compute(t,e,i){for(this._todo=[],this._done={},this._fromX=t,this._fromY=e,this._add(this._toX,this._toY,null);this._todo.length;){let i=this._todo.shift(),s=i.x+","+i.y;if(s in this._done)continue;if(this._done[s]=i,i.x==t&&i.y==e)break;let n=this._getNeighbors(i.x,i.y);for(let t=0;t<n.length;t++){let e=n[t],s=e[0],r=e[1];s+","+r in this._done||this._add(s,r,i)}}let s=this._done[t+","+e];if(s)for(;s;)i(s.x,s.y),s=s.prev}_add(t,e,i){let s=this._distance(t,e),n={x:t,y:e,prev:i,g:i?i.g+1:0,h:s},r=n.g+n.h;for(let t=0;t<this._todo.length;t++){let e=this._todo[t],i=e.g+e.h;if(r<i||r==i&&s<e.h)return void this._todo.splice(t,0,n)}this._todo.push(n)}_distance(t,e){switch(this._options.topology){case 4:return Math.abs(t-this._fromX)+Math.abs(e-this._fromY);case 6:let i=Math.abs(t-this._fromX),s=Math.abs(e-this._fromY);return s+Math.max(0,(i-s)/2);case 8:return Math.max(Math.abs(t-this._fromX),Math.abs(e-this._fromY))}}}};class xt{constructor(t){this._scheduler=t,this._lock=1}start(){return this.unlock()}lock(){return this._lock++,this}unlock(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){let t=this._scheduler.next();if(!t)return this.lock();let e=t.act();e&&e.then&&(this.lock(),e.then(this.unlock.bind(this)))}return this}}const St=U;var kt=new(function(){function t(){this.interval=100,this.pressed={},this.subs=[],window.addEventListener("keydown",this),window.addEventListener("keyup",this)}return t.prototype.handleEvent=function(t){var e=this,i=t.keyCode;"keydown"==t.type&&(i in this.pressed||(this.click(t.keyCode),this.pressed[i]=window.setInterval(function(){return e.click(t.keyCode)},this.interval))),"keyup"==t.type&&(window.clearInterval(this.pressed[i]),delete this.pressed[i])},t.prototype.click=function(t){for(var e=0,i=this.subs;e<i.length;e++){(0,i[e])(t)}},t.prototype.sub=function(t){this.subs.push(t)},t.prototype.unsub=function(t){this.subs=this.subs.filter(function(e){return e!=t})},t.prototype.once=function(t){var e=this,i=function(s){e.unsub(i),t(s)};this.sub(i)},t.prototype.isPressed=function(t){return t in this.pressed},t}());console.log(kt);var Tt,Mt={38:0,33:1,39:2,34:3,40:4,35:5,37:6,36:7,12:-1},Ct=function(){function t(){this.sees=[],this.path=[],this.hate=0,this.dead=!1,Tt.mobs.push(this)}return t.prototype.getSpeed=function(){return this==Tt.player?120+this.hate:100},t.prototype.act=function(){var t=this;if(this==Tt.player)Tt.engine.lock(),Tt.seeingRed?(this.playerAct(null),window.setTimeout(function(){return Tt.engine.unlock()},50)):kt.once(this.keyDown.bind(this));else if(this.path&&this.path.length>0)this.goTo(this.path.shift());else{this.path=[];var e=S.getItem(Tt.rooms).getCenter();new wt.AStar(e[0],e[1],function(t,e){return Tt.at([t,e]).cost<1e3},{topology:4}).compute(this.at[0],this.at[1],function(e,i){return t.path.push([e,i])}),this.path.shift()}},t.prototype.tile=function(){return Tt.at(this.at)},t.prototype.goTo=function(t){var e=this.tile(),i=Tt.at(t).mob;if(i){if(i==Tt.player)return;if(this==Tt.player)i.die(),this.hate=0;else{if(S.getUniform()<.5)return;i.at=this.at.slice(0,2),e.mob=i}}e.mob==this&&(e.mob=null),this.at=t.slice(0,2),this.tile().mob=this,this==Tt.player?("⚘"==this.tile().symbol&&(this.tile().symbol=" ",Tt.flowersCollected++),"☨"==this.tile().symbol&&Tt.allFlowersCollected()&&(Tt.won=!0)):this.leaveScent()},t.prototype.die=function(){var t=this;this.dead=!0,Tt.mobs=Tt.mobs.filter(function(e){return e!=t}),this.tile().mob=null,Tt.engine._scheduler.remove(this),new dt.PreciseShadowcasting(function(t,e){return Tt.safeAt([t,e]).cost<1e3}).compute(this.at[0],this.at[1],3,function(t,e,i,s){var n=Tt.at([t,e]);" "==n.symbol&&(n.symbol="*")})},t.prototype.leaveScent=function(){var t=Tt.at(this.at);t.mob=this,t.scent<=.01&&Tt.scent.push(t),t.scent=1},t.prototype.playerAct=function(t){var e=this;if(t){if(!(t in Mt))return;var i=Mt[t],s=-1==i?[0,0]:st[8][i],n=[this.at[0]+s[0],this.at[1]+s[1]];if(Tt.at(n).cost>1e3)return;this.goTo(n)}else{for(var r=1e3,o=null,h=0,a=Tt.mobs;h<a.length;h++){var l=a[h];if(l!=Tt.player){var c=zt(l.at,Tt.player.at);c<r&&(r=c,o=l)}}if(o){var u=new wt.AStar(o.at[0],o.at[1],function(t,e){return Tt.at([t,e]).cost<1e3},{topology:4});this.path=[],u.compute(this.at[0],this.at[1],function(t,i){return e.path.push([t,i])}),this.goTo(this.path[1])}}this.lookAround(),(S.getUniform()<.3||100==Tt.player.hate)&&(Tt.seeingRed=this.hate/100>S.getUniform()),Tt.draw()},t.prototype.keyDown=function(t){this.playerAct(t),Tt.engine.unlock()},t.prototype.enrage=function(t){this.hate=Math.min(Math.max(0,this.hate+t),100)},t.prototype.lookAround=function(){for(var t=this,e=0,i=this.sees;e<i.length;e++){var s=i[e];Tt.at(s).visible=0}for(var n=-4;n<=4;n++)for(var r=-4;r<=4;r++){var o=Tt.safeAt([this.at[0]+n,this.at[1]+r]);o!=Tt.emptyTile&&(o.seen=1)}var h=new dt.PreciseShadowcasting(function(t,e){return Tt.safeAt([t,e]).cost<1e3});this.sees=[];var a=Tt.seeingRed?-.5:-.3,l=!1;h.compute(this.at[0],this.at[1],20,function(e,i,s,n){t.sees.push([e,i]);var r=Tt.at([e,i]);"⚘"==r.symbol&&s<=10&&(l=!0),r.mob&&r.mob!=Tt.player&&(a+=10/(s+5)),r.visible=n*(20-s)/20,r.seen=1}),this.tile().scent>.1&&(a+=2*this.tile().scent),l&&(a>0?a*=2:a+=-3),this.enrage(a)},t.prototype.actFixedInterval=function(){},t}(),Et=St.fromString("#180C24");function zt(t,e){var i=t[0]-e[0],s=t[1]-e[1];return Math.sqrt(i*i+s*s)}var Pt=function(){function t(){}return t.prototype.getSpeed=function(){return 100},t.prototype.act=function(){Tt.scent=Tt.scent.filter(function(t){return t.scent=Math.max(t.scent-.05,.01),t.scent>.01});for(var t=0,e=Tt.mobs;t<e.length;t++){e[t].actFixedInterval()}},t}(),At=function(){return function(t){this.symbol=t,this.seen=0,this.visible=0,this.scent=0,this.cost=["♠","♣"].includes(t)?1e6:1}}();function Rt(t,e){return[t[0]+e[0],t[1]+e[1]]}var Wt=function(){function t(t){void 0===t&&(t={}),this.options=t,this.mobs=[],this.seeingRed=!1,this.emptyTile=new At("♠"),this.flowersCollected=0,this.scent=[],this.won=!1,this.mobStatus=[],this.flowerStatus=[],Tt=this,S.setSeed(t.seed||Math.random()),this.player=new Ct,this.size=t.size||[60,60],t.emptiness=1*t.emptiness||.35,t.mobs=1*t.mobs||10,t.flowers=1*t.flowers||4,this.displaySize=t.displaySize||[60,60];var e=this.d=new ot({width:this.displaySize[0],height:this.displaySize[1],fontSize:20,spacing:.6,forceSquareRatio:!0,bg:"#180C24",fontFamily:"Icons"});document.getElementById("game").appendChild(e.getContainer()),this.generateMap();var i=new lt.Speed;i.add(new Pt,!0);for(var s=0,n=this.mobs;s<n.length;s++){var r=n[s];i.add(r,!0)}this.engine=new xt(i),this.engine.start(),this.player.lookAround(),this.draw()}return t.prototype.at=function(t){return this.grid[t[0]][t[1]]},t.prototype.safeAt=function(t){return t[0]<0||t[1]<0||t[0]>=this.size[0]||t[1]>=this.size[1]?this.emptyTile:this.grid[t[0]][t[1]]},t.prototype.generateMap=function(){var t=this,e=this.size[0],i=this.size[1];this.grid=new Array(e).fill(null).map(function(t){return[]});var s=new bt(e,i,{dugPercentage:this.options.emptiness,corridorLength:[2,6],roomWidth:[3,6],roomHeight:[3,6]});s.create(function(e,i,s){var n=s?(e+i)%2?"♠":"♣":" ";t.grid[e][i]=new At(n)});var n=this.rooms=s.getRooms(),r=S.shuffle(n);this.at(r[0].getCenter()).symbol="☨",this.player.at=r[1].getCenter();for(var o=3;o<3+this.options.flowers;o++){var h=(a=r[o]).getCenter();this.flowerStatus.push(this.at(h)),this.at(h).symbol="⚘"}for(o=3+this.options.flowers;o<3+this.options.flowers+this.options.mobs;o++){var a=r[o],l=new Ct;this.mobStatus.push(l),l.at=a.getCenter()}},t.prototype.bg=function(t){var e=this.safeAt(t),i=[0,0,0];if(e.visible){var s=48*e.visible;i=St.add(i,[s,s,s])}else e.seen||0!=e.scent||(i=this.hateBg);if(e.scent>0){var n=e.scent,r=zt(t,this.player.at);.3*this.player.hate+10>r&&(i=St.add(i,[128*n,0,0]))}return St.toRGB(i)},t.prototype.draw=function(){this.d.drawText(0,0,"_".repeat(this.displaySize[1])),this.d.drawText(0,0,"%b{red}%c{red}"+"_".repeat(this.player.hate/this.displaySize[1]*100)),this.hateBg=this.seeingRed?[255,0,0]:St.add(Et,[.64*this.player.hate,0,0]);for(var t=[Math.floor(this.displaySize[0]/2),Math.floor(this.displaySize[1]/2)],e=[0,0],i=0,s=[0,1];i<s.length;i++){var n=s[i];e[n]=-this.player.at[n]+t[n]}for(var r=this.player.at[0]-t[0];r<this.player.at[0]+t[0];r++)for(var o=this.player.at[1]-t[1]+1;o<this.player.at[1]+t[1]-1;o++){var h=(u=this.safeAt([r,o])).visible||u.seen?u.symbol:" ",a=Rt([r,o],e);u.seen;this.d.draw(a[0],a[1],h,["♠","♣","."].includes(h)?null:"red",this.bg([r,o]))}for(var l=0,c=Tt.mobs;l<c.length;l++){var u,d=c[l];if((u=Tt.at(d.at)).visible){var f=Rt(d.at,e);h="white";this.player==d&&this.seeingRed&&(h="red"),this.d.draw(f[0],f[1],this.player==d?"☻":"☺",h,this.bg(d.at))}}this.d.drawText(0,this.displaySize[1]-1,"%b{#180C24}%c{#180C24}"+"_".repeat(this.displaySize[0]));var _="use NUMPAD ";_+="%c{gray}avoid? "+this.mobStatus.map(function(t){return t.dead?"%c{red}*":"%c{white}☺"}).join(""),this.won?_+=" %c{red}GAME COMPLETE":this.allFlowersCollected()?_+=" %c{gray}visit %c{red}☨":_+=" %c{gray}collect "+this.flowerStatus.map(function(t){return"⚘"==t.symbol?"%c{gray}⚘":"%c{red}⚘"}).join(""),this.d.drawText(0,this.displaySize[1]-1,_)},t.prototype.allFlowersCollected=function(){return this.flowersCollected==this.flowerStatus.length},t}();var Xt,Ot=(function(t){!function(){function e(t,e){document.addEventListener?t.addEventListener("scroll",e,!1):t.attachEvent("scroll",e)}function i(t){this.a=document.createElement("div"),this.a.setAttribute("aria-hidden","true"),this.a.appendChild(document.createTextNode(t)),this.b=document.createElement("span"),this.c=document.createElement("span"),this.h=document.createElement("span"),this.f=document.createElement("span"),this.g=-1,this.b.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.c.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.f.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.h.style.cssText="display:inline-block;width:200%;height:200%;font-size:16px;max-width:none;",this.b.appendChild(this.h),this.c.appendChild(this.f),this.a.appendChild(this.b),this.a.appendChild(this.c)}function s(t,e){t.a.style.cssText="max-width:none;min-width:20px;min-height:20px;display:inline-block;overflow:hidden;position:absolute;width:auto;margin:0;padding:0;top:-999px;white-space:nowrap;font-synthesis:none;font:"+e+";"}function n(t){var e=t.a.offsetWidth,i=e+100;return t.f.style.width=i+"px",t.c.scrollLeft=i,t.b.scrollLeft=t.b.scrollWidth+100,t.g!==e&&(t.g=e,!0)}function r(t,i){function s(){var t=r;n(t)&&t.a.parentNode&&i(t.g)}var r=t;e(t.b,s),e(t.c,s),n(t)}function o(t,e){var i=e||{};this.family=t,this.style=i.style||"normal",this.weight=i.weight||"normal",this.stretch=i.stretch||"normal"}var h=null,a=null,l=null,c=null;function u(){return null===c&&(c=!!document.fonts),c}function d(){if(null===l){var t=document.createElement("div");try{t.style.font="condensed 100px sans-serif"}catch(t){}l=""!==t.style.font}return l}function f(t,e){return[t.style,t.weight,d()?t.stretch:"","100px",e].join(" ")}o.prototype.load=function(t,e){var n=this,o=t||"BESbswy",l=0,c=e||3e3,d=(new Date).getTime();return new Promise(function(t,e){if(u()&&!function(){if(null===a)if(u()&&/Apple/.test(window.navigator.vendor)){var t=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))(?:\.([0-9]+))/.exec(window.navigator.userAgent);a=!!t&&603>parseInt(t[1],10)}else a=!1;return a}()){var _=new Promise(function(t,e){!function i(){(new Date).getTime()-d>=c?e(Error(c+"ms timeout exceeded")):document.fonts.load(f(n,'"'+n.family+'"'),o).then(function(e){1<=e.length?t():setTimeout(i,25)},e)}()}),p=new Promise(function(t,e){l=setTimeout(function(){e(Error(c+"ms timeout exceeded"))},c)});Promise.race([p,_]).then(function(){clearTimeout(l),t(n)},e)}else!function(t){document.body?t():document.addEventListener?document.addEventListener("DOMContentLoaded",function e(){document.removeEventListener("DOMContentLoaded",e),t()}):document.attachEvent("onreadystatechange",function e(){"interactive"!=document.readyState&&"complete"!=document.readyState||(document.detachEvent("onreadystatechange",e),t())})}(function(){function a(){var e;(e=-1!=g&&-1!=m||-1!=g&&-1!=v||-1!=m&&-1!=v)&&((e=g!=m&&g!=v&&m!=v)||(null===h&&(e=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent),h=!!e&&(536>parseInt(e[1],10)||536===parseInt(e[1],10)&&11>=parseInt(e[2],10))),e=h&&(g==b&&m==b&&v==b||g==y&&m==y&&v==y||g==w&&m==w&&v==w)),e=!e),e&&(x.parentNode&&x.parentNode.removeChild(x),clearTimeout(l),t(n))}var u=new i(o),_=new i(o),p=new i(o),g=-1,m=-1,v=-1,b=-1,y=-1,w=-1,x=document.createElement("div");x.dir="ltr",s(u,f(n,"sans-serif")),s(_,f(n,"serif")),s(p,f(n,"monospace")),x.appendChild(u.a),x.appendChild(_.a),x.appendChild(p.a),document.body.appendChild(x),b=u.a.offsetWidth,y=_.a.offsetWidth,w=p.a.offsetWidth,function t(){if((new Date).getTime()-d>=c)x.parentNode&&x.parentNode.removeChild(x),e(Error(c+"ms timeout exceeded"));else{var i=document.hidden;!0!==i&&void 0!==i||(g=u.a.offsetWidth,m=_.a.offsetWidth,v=p.a.offsetWidth,a()),l=setTimeout(t,50)}}(),r(u,function(t){g=t,a()}),s(u,f(n,'"'+n.family+'",sans-serif')),r(_,function(t){m=t,a()}),s(_,f(n,'"'+n.family+'",serif')),r(p,function(t){v=t,a()}),s(p,f(n,'"'+n.family+'",monospace'))})})},t.exports=o}()}(Xt={exports:{}},Xt.exports),Xt.exports);function Dt(t){var i;return{c(){var t;t="div",(i=document.createElement(t)).id="game"},m(t,e){!function(t,e,i){t.insertBefore(e,i||null)}(t,i,e)},p:e,i:e,o:e,d(t){var e;t&&(e=i).parentNode.removeChild(e)}}}let It=/[?&]([^=#]+)=([^&#]*)/g;function $t(t,e,i){let s,n=new Ot("Icons"),r={},o=(location.hash,window.location.href);for(;s=It.exec(o);)r[s[1]]=JSON.parse(s[2]);return console.log(r),n.load().then(()=>{new Wt(r)}),{}}class Ut extends y{constructor(t){super(),b(this,t,$t,Dt,o,[])}}return window.onload=function(){t.ui=new Ut({target:document.body})},t.default=app,t}({});
