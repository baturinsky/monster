var app=function(t){"use strict";function e(){}function i(t){return t()}function n(){return Object.create(null)}function s(t){t.forEach(i)}function o(t){return"function"==typeof t}function r(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}function a(t,e){t.appendChild(e)}function l(t,e,i){t.insertBefore(e,i||null)}function h(t){t.parentNode.removeChild(t)}function c(t,e){for(let i=0;i<t.length;i+=1)t[i]&&t[i].d(e)}function d(t){return document.createElement(t)}function u(t){return document.createTextNode(t)}function f(){return u(" ")}function p(t,e,i,n){return t.addEventListener(e,i,n),()=>t.removeEventListener(e,i,n)}function g(t,e){e=""+e,t.data!==e&&(t.data=e)}function m(t,e,i){t.style.setProperty(e,i)}let _;function y(t){_=t}function v(t){(function(){if(!_)throw new Error("Function called outside component initialization");return _})().$$.on_mount.push(t)}const b=[],w=Promise.resolve();let x=!1;const k=[],T=[],S=[];function I(){x||(x=!0,w.then(A))}function E(t){k.push(t)}function M(t){T.push(t)}function A(){const t=new Set;do{for(;b.length;){const t=b.shift();y(t),C(t.$$)}for(;k.length;)k.shift()();for(;T.length;){const e=T.pop();t.has(e)||(e(),t.add(e))}}while(b.length);for(;S.length;)S.pop()();x=!1}function C(t){t.fragment&&(t.update(t.dirty),s(t.before_render),t.fragment.p(t.dirty,t.ctx),t.dirty=null,t.after_render.forEach(M))}function P(t,r,a,l,h,c){const d=_;y(t);const u=r.props||{},f=t.$$={fragment:null,ctx:null,props:c,update:e,not_equal:h,bound:n(),on_mount:[],on_destroy:[],before_render:[],after_render:[],context:new Map(d?d.$$.context:[]),callbacks:n(),dirty:null};let p=!1;var g;f.ctx=a?a(t,u,(e,i)=>{f.ctx&&h(f.ctx[e],f.ctx[e]=i)&&(f.bound[e]&&f.bound[e](i),p&&function(t,e){t.$$.dirty||(b.push(t),I(),t.$$.dirty=n()),t.$$.dirty[e]=!0}(t,e))}):u,f.update(),p=!0,s(f.before_render),f.fragment=l(f.ctx),r.target&&(r.hydrate?f.fragment.l((g=r.target,Array.from(g.childNodes))):f.fragment.c(),r.intro&&t.$$.fragment.i&&t.$$.fragment.i(),function(t,e,n){const{fragment:r,on_mount:a,on_destroy:l,after_render:h}=t.$$;r.m(e,n),M(()=>{const e=a.map(i).filter(o);l?l.push(...e):s(e),t.$$.on_mount=[]}),h.forEach(M)}(t,r.target,r.anchor),A()),y(d)}class O{$destroy(){var t,i;i=!0,(t=this).$$&&(s(t.$$.on_destroy),t.$$.fragment.d(i),t.$$.on_destroy=t.$$.fragment=null,t.$$.ctx={}),this.$destroy=e}$on(t,e){const i=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return i.push(e),()=>{const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}$set(){}}var R=function(){return(R=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t}).apply(this,arguments)};const L=2.3283064365386963e-10;class D{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(t){return t=t<1?1/t:t,this._seed=t,this._s0=(t>>>0)*L,t=69069*t+1>>>0,this._s1=t*L,t=69069*t+1>>>0,this._s2=t*L,this._c=1,this}getUniform(){let t=2091639*this._s0+this._c*L;return this._s0=this._s1,this._s1=this._s2,this._c=0|t,this._s2=t-this._c,this._s2}getUniformInt(t,e){let i=Math.max(t,e),n=Math.min(t,e);return Math.floor(this.getUniform()*(i-n+1))+n}getNormal(t=0,e=1){let i,n,s;do{s=(i=2*this.getUniform()-1)*i+(n=2*this.getUniform()-1)*n}while(s>1||0==s);return t+i*Math.sqrt(-2*Math.log(s)/s)*e}getPercentage(){return 1+Math.floor(100*this.getUniform())}getItem(t){return t.length?t[Math.floor(this.getUniform()*t.length)]:null}shuffle(t){let e=[],i=t.slice();for(;i.length;){let t=i.indexOf(this.getItem(i));e.push(i.splice(t,1)[0])}return e}getWeightedValue(t){let e=0;for(let i in t)e+=t[i];let i,n=this.getUniform()*e,s=0;for(i in t)if(n<(s+=t[i]))return i;return i}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(t){return this._s0=t[0],this._s1=t[1],this._s2=t[2],this._c=t[3],this}clone(){return(new D).setState(this.getState())}}var z=(new D).setSeed(Date.now());class N{getContainer(){return null}setOptions(t){this._options=t}}class W extends N{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(t){requestAnimationFrame(t)}getContainer(){return this._ctx.canvas}setOptions(t){super.setOptions(t);const e=`${t.fontStyle?`${t.fontStyle} `:""} ${t.fontSize}px ${t.fontFamily}`;this._ctx.font=e,this._updateSize(),this._ctx.font=e,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height)}eventToPosition(t,e){let i=this._ctx.canvas,n=i.getBoundingClientRect();return t-=n.left,e-=n.top,t*=i.width/n.width,e*=i.height/n.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}}function F(t,e=0,i=1){return t<e?e:t>i?i:t}class B extends W{constructor(){super(),this._spacingX=0,this._spacingY=0,this._hexSize=0}draw(t,e){let[i,n,s,o,r]=t,a=[(i+1)*this._spacingX,n*this._spacingY+this._hexSize];if(this._options.transpose&&a.reverse(),e&&(this._ctx.fillStyle=r,this._fill(a[0],a[1])),!s)return;this._ctx.fillStyle=o;let l=[].concat(s);for(let t=0;t<l.length;t++)this._ctx.fillText(l[t],a[0],Math.ceil(a[1]))}computeSize(t,e){return this._options.transpose&&(t+=e,t-=e=t-e),[Math.floor(t/this._spacingX)-1,Math.floor((e-2*this._hexSize)/this._spacingY+1)]}computeFontSize(t,e){this._options.transpose&&(t+=e,t-=e=t-e);let i=2*t/((this._options.width+1)*Math.sqrt(3))-1,n=e/(2+1.5*(this._options.height-1)),s=Math.min(i,n),o=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let r=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=o;let a=r/100,l=2*(s=Math.floor(s)+1)/(this._options.spacing*(1+a/Math.sqrt(3)));return Math.ceil(l)-1}_normalizedEventToPosition(t,e){let i;this._options.transpose?(t+=e,t-=e=t-e,i=this._ctx.canvas.width):i=this._ctx.canvas.height;let n=i/this._options.height;return!function(t,e){return(t%e+e)%e}(e=Math.floor(e/n),2)?t=2*Math.floor(t/(2*this._spacingX)):(t-=this._spacingX,t=1+2*Math.floor(t/(2*this._spacingX))),[t,e]}_fill(t,e){let i=this._hexSize,n=this._options.border;const s=this._ctx;s.beginPath(),this._options.transpose?(s.moveTo(t-i+n,e),s.lineTo(t-i/2+n,e+this._spacingX-n),s.lineTo(t+i/2-n,e+this._spacingX-n),s.lineTo(t+i-n,e),s.lineTo(t+i/2-n,e-this._spacingX+n),s.lineTo(t-i/2+n,e-this._spacingX+n),s.lineTo(t-i+n,e)):(s.moveTo(t,e-i+n),s.lineTo(t+this._spacingX-n,e-i/2+n),s.lineTo(t+this._spacingX-n,e+i/2-n),s.lineTo(t,e+i-n),s.lineTo(t-this._spacingX+n,e+i/2-n),s.lineTo(t-this._spacingX+n,e-i/2+n),s.lineTo(t,e-i+n)),s.fill()}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);let i,n;this._hexSize=Math.floor(t.spacing*(t.fontSize+e/Math.sqrt(3))/2),this._spacingX=this._hexSize*Math.sqrt(3)/2,this._spacingY=1.5*this._hexSize,t.transpose?(i="height",n="width"):(i="width",n="height"),this._ctx.canvas[i]=Math.ceil((t.width+1)*this._spacingX),this._ctx.canvas[n]=Math.ceil((t.height-1)*this._spacingY+2*this._hexSize)}}class G extends W{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(t){super.setOptions(t),this._canvasCache={}}draw(t,e){G.cache?this._drawWithCache(t):this._drawNoCache(t,e)}_drawWithCache(t){let e,[i,n,s,o,r]=t,a=""+s+o+r;if(a in this._canvasCache)e=this._canvasCache[a];else{let t=this._options.border,i=(e=document.createElement("canvas")).getContext("2d");if(e.width=this._spacingX,e.height=this._spacingY,i.fillStyle=r,i.fillRect(t,t,e.width-t,e.height-t),s){i.fillStyle=o,i.font=this._ctx.font,i.textAlign="center",i.textBaseline="middle";let t=[].concat(s);for(let e=0;e<t.length;e++)i.fillText(t[e],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[a]=e}this._ctx.drawImage(e,i*this._spacingX,n*this._spacingY)}_drawNoCache(t,e){let[i,n,s,o,r]=t;if(e){let t=this._options.border;this._ctx.fillStyle=r,this._ctx.fillRect(i*this._spacingX+t,n*this._spacingY+t,this._spacingX-t,this._spacingY-t)}if(!s)return;this._ctx.fillStyle=o;let a=[].concat(s);for(let t=0;t<a.length;t++)this._ctx.fillText(a[t],(i+.5)*this._spacingX,Math.ceil((n+.5)*this._spacingY))}computeSize(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}computeFontSize(t,e){let i=Math.floor(t/this._options.width),n=Math.floor(e/this._options.height),s=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let o=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=s;let r=o/100*n/i;return r>1&&(n=Math.floor(n/r)),Math.floor(n/this._options.spacing)}_normalizedEventToPosition(t,e){return[Math.floor(t/this._spacingX),Math.floor(e/this._spacingY)]}_updateSize(){const t=this._options,e=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(t.spacing*e),this._spacingY=Math.ceil(t.spacing*t.fontSize),t.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=t.width*this._spacingX,this._ctx.canvas.height=t.height*this._spacingY}}G.cache=!1;class H extends W{constructor(){super(),this._colorCanvas=document.createElement("canvas")}draw(t,e){let[i,n,s,o,r]=t,a=this._options.tileWidth,l=this._options.tileHeight;if(e&&(this._options.tileColorize?this._ctx.clearRect(i*a,n*l,a,l):(this._ctx.fillStyle=r,this._ctx.fillRect(i*a,n*l,a,l))),!s)return;let h=[].concat(s),c=[].concat(o),d=[].concat(r);for(let t=0;t<h.length;t++){let e=this._options.tileMap[h[t]];if(!e)throw new Error(`Char "${h[t]}" not found in tileMap`);if(this._options.tileColorize){let s=this._colorCanvas,o=s.getContext("2d");o.globalCompositeOperation="source-over",o.clearRect(0,0,a,l);let r=c[t],h=d[t];o.drawImage(this._options.tileSet,e[0],e[1],a,l,0,0,a,l),"transparent"!=r&&(o.fillStyle=r,o.globalCompositeOperation="source-atop",o.fillRect(0,0,a,l)),"transparent"!=h&&(o.fillStyle=h,o.globalCompositeOperation="destination-over",o.fillRect(0,0,a,l)),this._ctx.drawImage(s,i*a,n*l,a,l)}else this._ctx.drawImage(this._options.tileSet,e[0],e[1],a,l,i*a,n*l,a,l)}}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._options;this._ctx.canvas.width=t.width*t.tileWidth,this._ctx.canvas.height=t.height*t.tileHeight,this._colorCanvas.width=t.tileWidth,this._colorCanvas.height=t.tileHeight}}function U(t){let e,i;if(t in J)e=J[t];else{if("#"==t.charAt(0)){let i=(t.match(/[0-9a-f]/gi)||[]).map(t=>parseInt(t,16));if(3==i.length)e=i.map(t=>17*t);else{for(let t=0;t<3;t++)i[t+1]+=16*i[t],i.splice(t,1);e=i}}else e=(i=t.match(/rgb\(([0-9, ]+)\)/i))?i[1].split(/\s*,\s*/).map(t=>parseInt(t)):[0,0,0];J[t]=e}return e.slice()}function X(t,e,i=.5){let n=t.slice();for(let s=0;s<3;s++)n[s]=Math.round(n[s]+i*(e[s]-t[s]));return n}const Y=X;function $(t,e,i=.5){let n=j(t),s=j(e);for(let t=0;t<3;t++)n[t]+=i*(s[t]-n[t]);return K(n)}const q=$;function j(t){let e,i=t[0]/255,n=t[1]/255,s=t[2]/255,o=Math.max(i,n,s),r=Math.min(i,n,s),a=0,l=(o+r)/2;if(o==r)e=0;else{let t=o-r;switch(e=l>.5?t/(2-o-r):t/(o+r),o){case i:a=(n-s)/t+(n<s?6:0);break;case n:a=(s-i)/t+2;break;case s:a=(i-n)/t+4}a/=6}return[a,e,l]}function V(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+(e-t)*(2/3-i)*6:t}function K(t){let e=t[2];if(0==t[1])return[e=Math.round(255*e),e,e];{let i=t[1],n=e<.5?e*(1+i):e+i-e*i,s=2*e-n,o=V(s,n,t[0]+1/3),r=V(s,n,t[0]),a=V(s,n,t[0]-1/3);return[Math.round(255*o),Math.round(255*r),Math.round(255*a)]}}const J={black:[0,0,0],navy:[0,0,128],darkblue:[0,0,139],mediumblue:[0,0,205],blue:[0,0,255],darkgreen:[0,100,0],green:[0,128,0],teal:[0,128,128],darkcyan:[0,139,139],deepskyblue:[0,191,255],darkturquoise:[0,206,209],mediumspringgreen:[0,250,154],lime:[0,255,0],springgreen:[0,255,127],aqua:[0,255,255],cyan:[0,255,255],midnightblue:[25,25,112],dodgerblue:[30,144,255],forestgreen:[34,139,34],seagreen:[46,139,87],darkslategray:[47,79,79],darkslategrey:[47,79,79],limegreen:[50,205,50],mediumseagreen:[60,179,113],turquoise:[64,224,208],royalblue:[65,105,225],steelblue:[70,130,180],darkslateblue:[72,61,139],mediumturquoise:[72,209,204],indigo:[75,0,130],darkolivegreen:[85,107,47],cadetblue:[95,158,160],cornflowerblue:[100,149,237],mediumaquamarine:[102,205,170],dimgray:[105,105,105],dimgrey:[105,105,105],slateblue:[106,90,205],olivedrab:[107,142,35],slategray:[112,128,144],slategrey:[112,128,144],lightslategray:[119,136,153],lightslategrey:[119,136,153],mediumslateblue:[123,104,238],lawngreen:[124,252,0],chartreuse:[127,255,0],aquamarine:[127,255,212],maroon:[128,0,0],purple:[128,0,128],olive:[128,128,0],gray:[128,128,128],grey:[128,128,128],skyblue:[135,206,235],lightskyblue:[135,206,250],blueviolet:[138,43,226],darkred:[139,0,0],darkmagenta:[139,0,139],saddlebrown:[139,69,19],darkseagreen:[143,188,143],lightgreen:[144,238,144],mediumpurple:[147,112,216],darkviolet:[148,0,211],palegreen:[152,251,152],darkorchid:[153,50,204],yellowgreen:[154,205,50],sienna:[160,82,45],brown:[165,42,42],darkgray:[169,169,169],darkgrey:[169,169,169],lightblue:[173,216,230],greenyellow:[173,255,47],paleturquoise:[175,238,238],lightsteelblue:[176,196,222],powderblue:[176,224,230],firebrick:[178,34,34],darkgoldenrod:[184,134,11],mediumorchid:[186,85,211],rosybrown:[188,143,143],darkkhaki:[189,183,107],silver:[192,192,192],mediumvioletred:[199,21,133],indianred:[205,92,92],peru:[205,133,63],chocolate:[210,105,30],tan:[210,180,140],lightgray:[211,211,211],lightgrey:[211,211,211],palevioletred:[216,112,147],thistle:[216,191,216],orchid:[218,112,214],goldenrod:[218,165,32],crimson:[220,20,60],gainsboro:[220,220,220],plum:[221,160,221],burlywood:[222,184,135],lightcyan:[224,255,255],lavender:[230,230,250],darksalmon:[233,150,122],violet:[238,130,238],palegoldenrod:[238,232,170],lightcoral:[240,128,128],khaki:[240,230,140],aliceblue:[240,248,255],honeydew:[240,255,240],azure:[240,255,255],sandybrown:[244,164,96],wheat:[245,222,179],beige:[245,245,220],whitesmoke:[245,245,245],mintcream:[245,255,250],ghostwhite:[248,248,255],salmon:[250,128,114],antiquewhite:[250,235,215],linen:[250,240,230],lightgoldenrodyellow:[250,250,210],oldlace:[253,245,230],red:[255,0,0],fuchsia:[255,0,255],magenta:[255,0,255],deeppink:[255,20,147],orangered:[255,69,0],tomato:[255,99,71],hotpink:[255,105,180],coral:[255,127,80],darkorange:[255,140,0],lightsalmon:[255,160,122],orange:[255,165,0],lightpink:[255,182,193],pink:[255,192,203],gold:[255,215,0],peachpuff:[255,218,185],navajowhite:[255,222,173],moccasin:[255,228,181],bisque:[255,228,196],mistyrose:[255,228,225],blanchedalmond:[255,235,205],papayawhip:[255,239,213],lavenderblush:[255,240,245],seashell:[255,245,238],cornsilk:[255,248,220],lemonchiffon:[255,250,205],floralwhite:[255,250,240],snow:[255,250,250],yellow:[255,255,0],lightyellow:[255,255,224],ivory:[255,255,240],white:[255,255,255]};var Q=Object.freeze({fromString:U,add:function(t,...e){let i=t.slice();for(let t=0;t<3;t++)for(let n=0;n<e.length;n++)i[t]+=e[n][t];return i},add_:function(t,...e){for(let i=0;i<3;i++)for(let n=0;n<e.length;n++)t[i]+=e[n][i];return t},multiply:function(t,...e){let i=t.slice();for(let t=0;t<3;t++){for(let n=0;n<e.length;n++)i[t]*=e[n][t]/255;i[t]=Math.round(i[t])}return i},multiply_:function(t,...e){for(let i=0;i<3;i++){for(let n=0;n<e.length;n++)t[i]*=e[n][i]/255;t[i]=Math.round(t[i])}return t},interpolate:X,lerp:Y,interpolateHSL:$,lerpHSL:q,randomize:function(t,e){e instanceof Array||(e=Math.round(z.getNormal(0,e)));let i=t.slice();for(let t=0;t<3;t++)i[t]+=e instanceof Array?Math.round(z.getNormal(0,e[t])):e;return i},rgb2hsl:j,hsl2rgb:K,toRGB:function(t){return`rgb(${t.map(t=>F(t,0,255)).join(",")})`},toHex:function(t){return`#${t.map(t=>F(t,0,255).toString(16).padStart(2,"0")).join("")}`}});class Z extends N{static isSupported(){return!!document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0})}constructor(){super(),this._uniforms={};try{this._gl=this._initWebGL()}catch(t){alert(t.message)}}schedule(t){requestAnimationFrame(t)}getContainer(){return this._gl.canvas}setOptions(t){super.setOptions(t),this._updateSize();let e=this._options.tileSet;e&&"complete"in e&&!e.complete?e.addEventListener("load",()=>this._updateTexture(e)):this._updateTexture(e)}draw(t,e){const i=this._gl,n=this._options;let[s,o,r,a,l]=t,h=i.canvas.height-(o+1)*n.tileHeight;if(i.scissor(s*n.tileWidth,h,n.tileWidth,n.tileHeight),e&&(n.tileColorize?i.clearColor(0,0,0,0):i.clearColor(...st(l)),i.clear(i.COLOR_BUFFER_BIT)),!r)return;let c=[].concat(r),d=[].concat(l),u=[].concat(a);i.uniform2fv(this._uniforms.targetPosRel,[s,o]);for(let t=0;t<c.length;t++){let e=this._options.tileMap[c[t]];if(!e)throw new Error(`Char "${c[t]}" not found in tileMap`);i.uniform1f(this._uniforms.colorize,n.tileColorize?1:0),i.uniform2fv(this._uniforms.tilesetPosAbs,e),n.tileColorize&&(i.uniform4fv(this._uniforms.tint,st(u[t])),i.uniform4fv(this._uniforms.bg,st(d[t]))),i.drawArrays(i.TRIANGLE_STRIP,0,4)}}clear(){const t=this._gl;t.clearColor(...st(this._options.bg)),t.scissor(0,0,t.canvas.width,t.canvas.height),t.clear(t.COLOR_BUFFER_BIT)}computeSize(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}computeFontSize(){throw new Error("Tile backend does not understand font size")}eventToPosition(t,e){let i=this._gl.canvas,n=i.getBoundingClientRect();return t-=n.left,e-=n.top,t*=i.width/n.width,e*=i.height/n.height,t<0||e<0||t>=i.width||e>=i.height?[-1,-1]:this._normalizedEventToPosition(t,e)}_initWebGL(){let t=document.createElement("canvas").getContext("webgl2",{preserveDrawingBuffer:!0});window.gl=t;let e=function(t,e,i){const n=t.createShader(t.VERTEX_SHADER);if(t.shaderSource(n,e),t.compileShader(n),!t.getShaderParameter(n,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(n)||"");const s=t.createShader(t.FRAGMENT_SHADER);if(t.shaderSource(s,i),t.compileShader(s),!t.getShaderParameter(s,t.COMPILE_STATUS))throw new Error(t.getShaderInfoLog(s)||"");const o=t.createProgram();if(t.attachShader(o,n),t.attachShader(o,s),t.linkProgram(o),!t.getProgramParameter(o,t.LINK_STATUS))throw new Error(t.getProgramInfoLog(o)||"");return o}(t,et,it);return t.useProgram(e),function(t){const e=new Float32Array([0,0,1,0,0,1,1,1]),i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,e,t.STATIC_DRAW),t.enableVertexAttribArray(0),t.vertexAttribPointer(0,2,t.FLOAT,!1,0,0)}(t),tt.forEach(i=>this._uniforms[i]=t.getUniformLocation(e,i)),this._program=e,t.enable(t.BLEND),t.blendFuncSeparate(t.SRC_ALPHA,t.ONE_MINUS_SRC_ALPHA,t.ONE,t.ONE_MINUS_SRC_ALPHA),t.enable(t.SCISSOR_TEST),t}_normalizedEventToPosition(t,e){return[Math.floor(t/this._options.tileWidth),Math.floor(e/this._options.tileHeight)]}_updateSize(){const t=this._gl,e=this._options,i=[e.width*e.tileWidth,e.height*e.tileHeight];t.canvas.width=i[0],t.canvas.height=i[1],t.viewport(0,0,i[0],i[1]),t.uniform2fv(this._uniforms.tileSize,[e.tileWidth,e.tileHeight]),t.uniform2fv(this._uniforms.targetSize,i)}_updateTexture(t){!function(t,e){let i=t.createTexture();t.bindTexture(t.TEXTURE_2D,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.REPEAT),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.REPEAT),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,0),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,e)}(this._gl,t)}}const tt=["targetPosRel","tilesetPosAbs","tileSize","targetSize","colorize","bg","tint"],et="\n#version 300 es\n\nin vec2 tilePosRel;\nout vec2 tilesetPosPx;\n\nuniform vec2 tilesetPosAbs;\nuniform vec2 tileSize;\nuniform vec2 targetSize;\nuniform vec2 targetPosRel;\n\nvoid main() {\n\tvec2 targetPosPx = (targetPosRel + tilePosRel) * tileSize;\n\tvec2 targetPosNdc = ((targetPosPx / targetSize)-0.5)*2.0;\n\ttargetPosNdc.y *= -1.0;\n\n\tgl_Position = vec4(targetPosNdc, 0.0, 1.0);\n\ttilesetPosPx = tilesetPosAbs + tilePosRel * tileSize;\n}".trim(),it="\n#version 300 es\nprecision highp float;\n\nin vec2 tilesetPosPx;\nout vec4 fragColor;\nuniform sampler2D image;\nuniform bool colorize;\nuniform vec4 bg;\nuniform vec4 tint;\n\nvoid main() {\n\tfragColor = vec4(0, 0, 0, 1);\n\n\tvec4 texel = texelFetch(image, ivec2(tilesetPosPx), 0);\n\n\tif (colorize) {\n\t\ttexel.rgb = tint.a * tint.rgb + (1.0-tint.a) * texel.rgb;\n\t\tfragColor.rgb = texel.a*texel.rgb + (1.0-texel.a)*bg.rgb;\n\t\tfragColor.a = texel.a + (1.0-texel.a)*bg.a;\n\t} else {\n\t\tfragColor = texel;\n\t}\n}".trim();let nt={};function st(t){if(!(t in nt)){let e;if("transparent"==t)e=[0,0,0,0];else if(t.indexOf("rgba")>-1){e=(t.match(/[\d.]+/g)||[]).map(Number);for(let t=0;t<3;t++)e[t]=e[t]/255}else(e=U(t).map(t=>t/255)).push(1);nt[t]=e}return nt[t]}function ot(t){let e=U(t);return 36*Math.floor(e[0]*(6/256))+6*Math.floor(e[1]*(6/256))+1*Math.floor(e[2]*(6/256))+16}class rt extends N{constructor(){super(),this._offset=[0,0],this._cursor=[-1,-1],this._lastColor=""}schedule(t){setTimeout(t,1e3/60)}setOptions(t){super.setOptions(t);let e=[t.width,t.height],i=this.computeSize();this._offset=i.map((t,i)=>Math.floor((t-e[i])/2))}clear(){process.stdout.write(`[0;48;5;${ot(this._options.bg)}m[2J`)}draw(t,e){let[i,n,s,o,r]=t,a=this._offset[0]+i,l=this._offset[1]+n,h=this.computeSize();if(a<0||a>=h[0])return;if(l<0||l>=h[1])return;if(a===this._cursor[0]&&l===this._cursor[1]||(process.stdout.write(function(t,e){return`[${e+1};${t+1}H`}(a,l)),this._cursor[0]=a,this._cursor[1]=l),e&&(s||(s=" ")),!s)return;let c=function(t,e){return`[0;38;5;${ot(t)};48;5;${ot(e)}m`}(o,r);c!==this._lastColor&&(process.stdout.write(c),this._lastColor=c);let d=[].concat(s);process.stdout.write(d[0]),this._cursor[0]++,this._cursor[0]>=h[0]&&(this._cursor[0]=0,this._cursor[1]++)}computeFontSize(){throw new Error("Terminal backend has no notion of font size")}eventToPosition(t,e){return[t,e]}computeSize(){return[process.stdout.columns,process.stdout.rows]}}const at=/%([bc]){([^}]*)}/g,lt=0,ht=1,ct=2,dt=3;function ut(t,e){let i=[],n=0;t.replace(at,function(e,s,o,r){let a=t.substring(n,r);return a.length&&i.push({type:lt,value:a}),i.push({type:"c"==s?ct:dt,value:o.trim()}),n=r+e.length,""});let s=t.substring(n);return s.length&&i.push({type:lt,value:s}),function(t,e){e||(e=1/0);let i=0,n=0,s=-1;for(;i<t.length;){let o=t[i];if(o.type==ht&&(n=0,s=-1),o.type!=lt){i++;continue}for(;0==n&&" "==o.value.charAt(0);)o.value=o.value.substring(1);let r=o.value.indexOf("\n");if(-1!=r){o.value=ft(t,i,r,!0);let e=o.value.split("");for(;e.length&&" "==e[e.length-1];)e.pop();o.value=e.join("")}if(o.value.length){if(n+o.value.length>e){let r=-1;for(;;){let t=o.value.indexOf(" ",r+1);if(-1==t)break;if(n+t>e)break;r=t}if(-1!=r)o.value=ft(t,i,r,!0);else if(-1!=s){let e=t[s],n=e.value.lastIndexOf(" ");e.value=ft(t,s,n,!0),i=s}else o.value=ft(t,i,e-n,!1)}else n+=o.value.length,-1!=o.value.indexOf(" ")&&(s=i);i++}else t.splice(i,1)}t.push({type:ht});let o=null;for(let e=0;e<t.length;e++){let i=t[e];switch(i.type){case lt:o=i;break;case ht:if(o){let t=o.value.split("");for(;t.length&&" "==t[t.length-1];)t.pop();o.value=t.join("")}o=null}}return t.pop(),t}(i,e)}function ft(t,e,i,n){let s={type:ht},o={type:lt,value:t[e].value.substring(i+(n?1:0))};return t.splice(e+1,0,s,o),t[e].value.substring(0,i)}let pt=80,gt=25;const mt={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]},_t={hex:B,rect:G,tile:H,"tile-gl":Z,term:rt},yt={width:pt,height:gt,transpose:!1,layout:"rect",fontSize:15,spacing:1,border:0,forceSquareRatio:!1,fontFamily:"monospace",fontStyle:"",fg:"#ccc",bg:"#000",tileWidth:32,tileHeight:32,tileMap:{},tileSet:null,tileColorize:!1};class vt{constructor(t={}){this._data={},this._dirty=!1,this._options={},t=Object.assign({},yt,t),this.setOptions(t),this.DEBUG=this.DEBUG.bind(this),this._tick=this._tick.bind(this),this._backend.schedule(this._tick)}DEBUG(t,e,i){let n=[this._options.bg,this._options.fg];this.draw(t,e,null,null,n[i%n.length])}clear(){this._data={},this._dirty=!0}setOptions(t){if(Object.assign(this._options,t),t.width||t.height||t.fontSize||t.fontFamily||t.spacing||t.layout){if(t.layout){let e=_t[t.layout];this._backend=new e}this._backend.setOptions(this._options),this._dirty=!0}return this}getOptions(){return this._options}getContainer(){return this._backend.getContainer()}computeSize(t,e){return this._backend.computeSize(t,e)}computeFontSize(t,e){return this._backend.computeFontSize(t,e)}computeTileSize(t,e){return[Math.floor(t/this._options.width),Math.floor(e/this._options.height)]}eventToPosition(t){let e,i;return"touches"in t?(e=t.touches[0].clientX,i=t.touches[0].clientY):(e=t.clientX,i=t.clientY),this._backend.eventToPosition(e,i)}draw(t,e,i,n,s){n||(n=this._options.fg),s||(s=this._options.bg);let o=`${t},${e}`;this._data[o]=[t,e,i,n,s],!0!==this._dirty&&(this._dirty||(this._dirty={}),this._dirty[o]=!0)}drawText(t,e,i,n){let s=null,o=null,r=t,a=e,l=1;n||(n=this._options.width-t);let h=ut(i,n);for(;h.length;){let e=h.shift();switch(e.type){case lt:let i=!1,n=!1,h=!1,c=!1;for(let t=0;t<e.value.length;t++){let l=e.value.charCodeAt(t),d=e.value.charAt(t);h=l>65280&&l<65377||l>65500&&l<65512||l>65518,i=32==d.charCodeAt(0)||12288==d.charCodeAt(0),!c||h||i||r++,h&&!n&&r++,this.draw(r++,a,d,s,o),n=i,c=h}break;case ct:s=e.value||null;break;case dt:o=e.value||null;break;case ht:r=t,a++,l++}}return l}_tick(){if(this._backend.schedule(this._tick),this._dirty){if(!0===this._dirty){this._backend.clear();for(let t in this._data)this._draw(t,!1)}else for(let t in this._dirty)this._draw(t,!0);this._dirty=!1}}_draw(t,e){let i=this._data[t];i[4]!=this._options.bg&&(e=!0),this._backend.draw(i,e)}}vt.Rect=G,vt.Hex=B,vt.Tile=H,vt.TileGL=Z,vt.Term=rt;class bt{constructor(){this._time=0,this._events=[],this._eventTimes=[]}getTime(){return this._time}clear(){return this._events=[],this._eventTimes=[],this}add(t,e){let i=this._events.length;for(let t=0;t<this._eventTimes.length;t++)if(this._eventTimes[t]>e){i=t;break}this._events.splice(i,0,t),this._eventTimes.splice(i,0,e)}get(){if(!this._events.length)return null;let t=this._eventTimes.splice(0,1)[0];if(t>0){this._time+=t;for(let e=0;e<this._eventTimes.length;e++)this._eventTimes[e]-=t}return this._events.splice(0,1)[0]}getEventTime(t){let e=this._events.indexOf(t);if(-1!=e)return this._eventTimes[e]}remove(t){let e=this._events.indexOf(t);return-1!=e&&(this._remove(e),!0)}_remove(t){this._events.splice(t,1),this._eventTimes.splice(t,1)}}class wt{constructor(){this._queue=new bt,this._repeat=[],this._current=null}getTime(){return this._queue.getTime()}add(t,e){return e&&this._repeat.push(t),this}getTimeOf(t){return this._queue.getEventTime(t)}clear(){return this._queue.clear(),this._repeat=[],this._current=null,this}remove(t){let e=this._queue.remove(t),i=this._repeat.indexOf(t);return-1!=i&&this._repeat.splice(i,1),this._current==t&&(this._current=null),e}next(){return this._current=this._queue.get(),this._current}}var xt={Simple:class extends wt{add(t,e){return this._queue.add(t,0),super.add(t,e)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,0),super.next()}},Speed:class extends wt{add(t,e,i){return this._queue.add(t,void 0!==i?i:1/t.getSpeed()),super.add(t,e)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&this._queue.add(this._current,1/this._current.getSpeed()),super.next()}},Action:class extends wt{constructor(){super(),this._defaultDuration=1,this._duration=this._defaultDuration}add(t,e,i){return this._queue.add(t,i||this._defaultDuration),super.add(t,e)}clear(){return this._duration=this._defaultDuration,super.clear()}remove(t){return t==this._current&&(this._duration=this._defaultDuration),super.remove(t)}next(){return this._current&&-1!=this._repeat.indexOf(this._current)&&(this._queue.add(this._current,this._duration||this._defaultDuration),this._duration=this._defaultDuration),super.next()}setDuration(t){return this._current&&(this._duration=t),this}}};class kt{constructor(t,e={}){this._lightPasses=t,this._options=Object.assign({topology:8},e)}_getCircle(t,e,i){let n,s,o,r=[];switch(this._options.topology){case 4:s=1,o=[0,1],n=[mt[8][7],mt[8][1],mt[8][3],mt[8][5]];break;case 6:n=mt[6],s=1,o=[-1,1];break;case 8:n=mt[4],s=2,o=[-1,1];break;default:throw new Error("Incorrect topology for FOV computation")}let a=t+o[0]*i,l=e+o[1]*i;for(let t=0;t<n.length;t++)for(let e=0;e<i*s;e++)r.push([a,l]),a+=n[t][0],l+=n[t][1];return r}}const Tt=[[-1,0,0,1],[0,-1,1,0],[0,-1,-1,0],[-1,0,0,-1],[1,0,0,-1],[0,1,-1,0],[0,1,1,0],[1,0,0,1]];var St={DiscreteShadowcasting:class extends kt{compute(t,e,i,n){if(n(t,e,0,1),!this._lightPasses(t,e))return;let s,o,r,a,l,h=[];for(let c=1;c<=i;c++){let i=this._getCircle(t,e,c),d=360/i.length;for(let t=0;t<i.length;t++)if(r=i[t][0],a=i[t][1],o=(s=d*(t-.5))+d,l=!this._lightPasses(r,a),this._visibleCoords(Math.floor(s),Math.ceil(o),l,h)&&n(r,a,c,1),2==h.length&&0==h[0]&&360==h[1])return}}_visibleCoords(t,e,i,n){if(t<0){let s=this._visibleCoords(0,e,i,n),o=this._visibleCoords(360+t,360,i,n);return s||o}let s=0;for(;s<n.length&&n[s]<t;)s++;if(s==n.length)return i&&n.push(t,e),!0;let o=0;if(s%2){for(;s<n.length&&n[s]<e;)s++,o++;return 0!=o&&(i&&(o%2?n.splice(s-o,o,e):n.splice(s-o,o)),!0)}for(;s<n.length&&n[s]<e;)s++,o++;return(t!=n[s-o]||1!=o)&&(i&&(o%2?n.splice(s-o,o,t):n.splice(s-o,o,t,e)),!0)}},PreciseShadowcasting:class extends kt{compute(t,e,i,n){if(n(t,e,0,1),!this._lightPasses(t,e))return;let s,o,r,a,l,h,c=[];for(let d=1;d<=i;d++){let i=this._getCircle(t,e,d),u=i.length;for(let t=0;t<u;t++)if(s=i[t][0],o=i[t][1],a=[t?2*t-1:2*u-1,2*u],l=[2*t+1,2*u],r=!this._lightPasses(s,o),(h=this._checkVisibility(a,l,r,c))&&n(s,o,d,h),2==c.length&&0==c[0][0]&&c[1][0]==c[1][1])return}}_checkVisibility(t,e,i,n){if(t[0]>e[0])return(this._checkVisibility(t,[t[1],t[1]],i,n)+this._checkVisibility([0,1],e,i,n))/2;let s=0,o=!1;for(;s<n.length;){let e=n[s],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0!=i||s%2||(o=!0);break}s++}let r=n.length,a=!1;for(;r--;){let t=n[r],i=e[0]*t[1]-t[0]*e[1];if(i>=0){0==i&&r%2&&(a=!0);break}}let l,h=!0;if(s==r&&(o||a)?h=!1:o&&a&&s+1==r&&r%2?h=!1:s>r&&s%2&&(h=!1),!h)return 0;let c=r-s+1;if(c%2)if(s%2){let t=n[s];l=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&n.splice(s,c,e)}else{let e=n[r];l=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&n.splice(s,c,t)}else{if(!(s%2))return i&&n.splice(s,c,t,e),1;{let t=n[s],e=n[r];l=(e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]),i&&n.splice(s,c)}}return l/((e[0]*t[1]-t[0]*e[1])/(t[1]*e[1]))}},RecursiveShadowcasting:class extends kt{compute(t,e,i,n){n(t,e,0,1);for(let s=0;s<Tt.length;s++)this._renderOctant(t,e,Tt[s],i,n)}compute180(t,e,i,n,s){s(t,e,0,1);let o=(n-1+8)%8,r=(n-2+8)%8,a=(n+1+8)%8;this._renderOctant(t,e,Tt[r],i,s),this._renderOctant(t,e,Tt[o],i,s),this._renderOctant(t,e,Tt[n],i,s),this._renderOctant(t,e,Tt[a],i,s)}compute90(t,e,i,n,s){s(t,e,0,1);let o=(n-1+8)%8;this._renderOctant(t,e,Tt[n],i,s),this._renderOctant(t,e,Tt[o],i,s)}_renderOctant(t,e,i,n,s){this._castVisibility(t,e,1,1,0,n+1,i[0],i[1],i[2],i[3],s)}_castVisibility(t,e,i,n,s,o,r,a,l,h,c){if(!(n<s))for(let d=i;d<=o;d++){let i=-d-1,u=-d,f=!1,p=0;for(;i<=0;){let g=t+(i+=1)*r+u*a,m=e+i*l+u*h,_=(i-.5)/(u+.5),y=(i+.5)/(u-.5);if(!(y>n)){if(_<s)break;if(i*i+u*u<o*o&&c(g,m,d,1),f){if(!this._lightPasses(g,m)){p=y;continue}f=!1,n=p}else!this._lightPasses(g,m)&&d<o&&(f=!0,this._castVisibility(t,e,d+1,n,_,o,r,a,l,h,c),p=y)}}if(f)break}}}};class It{constructor(t=pt,e=gt){this._width=t,this._height=e}_fillMap(t){let e=[];for(let i=0;i<this._width;i++){e.push([]);for(let n=0;n<this._height;n++)e[i].push(t)}return e}}class Et extends It{constructor(t,e){super(t,e),this._rooms=[],this._corridors=[]}getRooms(){return this._rooms}getCorridors(){return this._corridors}}class Mt{}class At extends Mt{constructor(t,e,i,n,s,o){super(),this._x1=t,this._y1=e,this._x2=i,this._y2=n,this._doors={},void 0!==s&&void 0!==o&&this.addDoor(s,o)}static createRandomAt(t,e,i,n,s){let o=s.roomWidth[0],r=s.roomWidth[1],a=z.getUniformInt(o,r);o=s.roomHeight[0],r=s.roomHeight[1];let l=z.getUniformInt(o,r);if(1==i){let i=e-Math.floor(z.getUniform()*l);return new this(t+1,i,t+a,i+l-1,t,e)}if(-1==i){let i=e-Math.floor(z.getUniform()*l);return new this(t-a,i,t-1,i+l-1,t,e)}if(1==n){let i=t-Math.floor(z.getUniform()*a);return new this(i,e+1,i+a-1,e+l,t,e)}if(-1==n){let i=t-Math.floor(z.getUniform()*a);return new this(i,e-l,i+a-1,e-1,t,e)}throw new Error("dx or dy must be 1 or -1")}static createRandomCenter(t,e,i){let n=i.roomWidth[0],s=i.roomWidth[1],o=z.getUniformInt(n,s);n=i.roomHeight[0],s=i.roomHeight[1];let r=z.getUniformInt(n,s),a=t-Math.floor(z.getUniform()*o),l=e-Math.floor(z.getUniform()*r);return new this(a,l,a+o-1,l+r-1)}static createRandom(t,e,i){let n=i.roomWidth[0],s=i.roomWidth[1],o=z.getUniformInt(n,s);n=i.roomHeight[0],s=i.roomHeight[1];let r=z.getUniformInt(n,s),a=t-o-1,l=e-r-1,h=1+Math.floor(z.getUniform()*a),c=1+Math.floor(z.getUniform()*l);return new this(h,c,h+o-1,c+r-1)}addDoor(t,e){return this._doors[t+","+e]=1,this}getDoors(t){for(let e in this._doors){let i=e.split(",");t(parseInt(i[0]),parseInt(i[1]))}return this}clearDoors(){return this._doors={},this}addDoors(t){let e=this._x1-1,i=this._x2+1,n=this._y1-1,s=this._y2+1;for(let o=e;o<=i;o++)for(let r=n;r<=s;r++)o!=e&&o!=i&&r!=n&&r!=s||t(o,r)||this.addDoor(o,r);return this}debug(){console.log("room",this._x1,this._y1,this._x2,this._y2)}isValid(t,e){let i=this._x1-1,n=this._x2+1,s=this._y1-1,o=this._y2+1;for(let r=i;r<=n;r++)for(let a=s;a<=o;a++)if(r==i||r==n||a==s||a==o){if(!t(r,a))return!1}else if(!e(r,a))return!1;return!0}create(t){let e=this._x1-1,i=this._x2+1,n=this._y1-1,s=this._y2+1,o=0;for(let r=e;r<=i;r++)for(let a=n;a<=s;a++)t(r,a,o=r+","+a in this._doors?2:r==e||r==i||a==n||a==s?1:0)}getCenter(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]}getLeft(){return this._x1}getRight(){return this._x2}getTop(){return this._y1}getBottom(){return this._y2}}class Ct extends Mt{constructor(t,e,i,n){super(),this._startX=t,this._startY=e,this._endX=i,this._endY=n,this._endsWithAWall=!0}static createRandomAt(t,e,i,n,s){let o=s.corridorLength[0],r=s.corridorLength[1],a=z.getUniformInt(o,r);return new this(t,e,t+i*a,e+n*a)}debug(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)}isValid(t,e){let i=this._startX,n=this._startY,s=this._endX-i,o=this._endY-n,r=1+Math.max(Math.abs(s),Math.abs(o));s&&(s/=Math.abs(s)),o&&(o/=Math.abs(o));let a=o,l=-s,h=!0;for(let c=0;c<r;c++){let d=i+c*s,u=n+c*o;if(e(d,u)||(h=!1),t(d+a,u+l)||(h=!1),t(d-a,u-l)||(h=!1),!h){r=c,this._endX=d-s,this._endY=u-o;break}}if(0==r)return!1;if(1==r&&t(this._endX+s,this._endY+o))return!1;let c=!t(this._endX+s+a,this._endY+o+l),d=!t(this._endX+s-a,this._endY+o-l);return this._endsWithAWall=t(this._endX+s,this._endY+o),!c&&!d||!this._endsWithAWall}create(t){let e=this._startX,i=this._startY,n=this._endX-e,s=this._endY-i,o=1+Math.max(Math.abs(n),Math.abs(s));n&&(n/=Math.abs(n)),s&&(s/=Math.abs(s));for(let r=0;r<o;r++){t(e+r*n,i+r*s,0)}return!0}createPriorityWalls(t){if(!this._endsWithAWall)return;let e=this._startX,i=this._startY,n=this._endX-e,s=this._endY-i;n&&(n/=Math.abs(n)),s&&(s/=Math.abs(s));let o=s,r=-n;t(this._endX+n,this._endY+s),t(this._endX+o,this._endY+r),t(this._endX-o,this._endY-r)}}const Pt={room:At,corridor:Ct};class Ot extends Et{constructor(t,e,i={}){super(t,e),this._options=Object.assign({roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},i),this._features={room:4,corridor:4},this._map=[],this._featureAttempts=20,this._walls={},this._dug=0,this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)}create(t){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;let e=(this._width-2)*(this._height-2);this._firstRoom();let i,n=Date.now();do{if(i=0,Date.now()-n>this._options.timeLimit)break;let t=this._findWall();if(!t)break;let e=t.split(","),s=parseInt(e[0]),o=parseInt(e[1]),r=this._getDiggingDirection(s,o);if(!r)continue;let a=0;do{if(a++,this._tryFeature(s,o,r[0],r[1])){this._removeSurroundingWalls(s,o),this._removeSurroundingWalls(s-r[0],o-r[1]);break}}while(a<this._featureAttempts);for(let t in this._walls)this._walls[t]>1&&i++}while(this._dug/e<this._options.dugPercentage||i);if(this._addDoors(),t)for(let e=0;e<this._width;e++)for(let i=0;i<this._height;i++)t(e,i,this._map[e][i]);return this._walls={},this._map=[],this}_digCallback(t,e,i){0==i||2==i?(this._map[t][e]=0,this._dug++):this._walls[t+","+e]=1}_isWallCallback(t,e){return!(t<0||e<0||t>=this._width||e>=this._height)&&1==this._map[t][e]}_canBeDugCallback(t,e){return!(t<1||e<1||t+1>=this._width||e+1>=this._height)&&1==this._map[t][e]}_priorityWallCallback(t,e){this._walls[t+","+e]=2}_firstRoom(){let t=Math.floor(this._width/2),e=Math.floor(this._height/2),i=At.createRandomCenter(t,e,this._options);this._rooms.push(i),i.create(this._digCallback)}_findWall(){let t=[],e=[];for(let i in this._walls){2==this._walls[i]?e.push(i):t.push(i)}let i=e.length?e:t;if(!i.length)return null;let n=z.getItem(i.sort());return delete this._walls[n],n}_tryFeature(t,e,i,n){let s=z.getWeightedValue(this._features),o=Pt[s].createRandomAt(t,e,i,n,this._options);return!!o.isValid(this._isWallCallback,this._canBeDugCallback)&&(o.create(this._digCallback),o instanceof At&&this._rooms.push(o),o instanceof Ct&&(o.createPriorityWalls(this._priorityWallCallback),this._corridors.push(o)),!0)}_removeSurroundingWalls(t,e){let i=mt[4];for(let n=0;n<i.length;n++){let s=i[n],o=t+s[0],r=e+s[1];delete this._walls[o+","+r],o=t+2*s[0],r=e+2*s[1],delete this._walls[o+","+r]}}_getDiggingDirection(t,e){if(t<=0||e<=0||t>=this._width-1||e>=this._height-1)return null;let i=null,n=mt[4];for(let s=0;s<n.length;s++){let o=n[s],r=t+o[0],a=e+o[1];if(!this._map[r][a]){if(i)return null;i=o}}return i?[-i[0],-i[1]]:null}_addDoors(){let t=this._map;function e(e,i){return 1==t[e][i]}for(let t=0;t<this._rooms.length;t++){let i=this._rooms[t];i.clearDoors(),i.addDoors(e)}}}class Rt{constructor(t){this._scheduler=t,this._lock=1}start(){return this.unlock()}lock(){return this._lock++,this}unlock(){if(!this._lock)throw new Error("Cannot unlock unlocked engine");for(this._lock--;!this._lock;){let t=this._scheduler.next();if(!t)return this.lock();let e=t.act();e&&e.then&&(this.lock(),e.then(this.unlock.bind(this)))}return this}}const Lt=Q;var Dt={Numpad8:0,Numpad9:1,Numpad6:2,Numpad3:3,Numpad2:4,Numpad1:5,Numpad4:6,Numpad7:7,Numpad5:-1,Space:-1},zt=function(){function t(e){void 0===e&&(e=t.MOB),this.type=e,this.sees=[],this.hate=0,this.fear=0,this.alive=!0,this.concentration=0,this.seesEnemies=!1,this.freeze=0,Jt.mobs.push(this)}return t.prototype.isPlayer=function(){return Jt.player==this},t.prototype.isGuard=function(){return this.type==t.RED_ONI||this.type==t.BLUE_ONI||this.type==t.ELDER},t.prototype.serialise=function(){var t={};return Object.assign(t,this),t},t.prototype.deserialise=function(e){return Object.assign(this,e),e.type==t.PLAYER&&(Jt.player=this),this},t.meansStop=function(t){return-1==Dt[t]},t.prototype.getSpeed=function(){var t=100;if(this.isPlayer())t=120+this.hate;else if(this.isGuard)return 120;return t},t.prototype.act=function(){if(this.alive||(console.log("zombie"),console.log(this)),this.freeze>0)this.freeze-=this.getSpeed();else{if(this.isGuard()&&!this.at){var t=Jt.at(Jt.exits[0]);t.mob||(this.at=Jt.exits[0].slice(),t.mob=this,console.log("Spawn guard"),console.log(this))}this.isPlayer()?(Jt.engine.lock(),Jt.playerAct()):this.at&&this.mobAct()}},t.prototype.tile=function(){return Jt.at(this.at)},t.prototype.fight=function(e){var i;if(console.log("FIGHT"),console.log(this),console.log(e),e.type==t.BLUE_ONI)i=this.hate<z.getUniformInt(1,100)+20,Jt.log(i?ee.blue_victory:ee.blue_lose);else if(e.type==t.RED_ONI)console.log(this.hate,z.getUniformInt(1,100)-20),i=this.hate>z.getUniformInt(1,100)-20,Jt.log(i?ee.red_victory:ee.red_lose);else{if(!(Jt.killed>0))return;i=!1,Jt.log(ee.elder_lose)}Jt.log(i?ee.death:ee.lose),i?e.die():this.die()},t.prototype.goTo=function(t){var e=this.tile();this.concentration=0;var i=Jt.at(t).mob;if(i)if(this.isPlayer()){if(i.isGuard())return void this.fight(i);i.die()}else{if(i.isPlayer()&&this.isGuard())return void i.fight(this);if(z.getUniform()<.5)return;i.at=this.at.slice(0,2),e.mob=i,i.reroute()}e.mob==this&&(e.mob=null),this.at=t.slice(0,2),(e=this.tile()).mob=this,this.isPlayer()?("⚘"==e.symbol&&(e.symbol=" ",Jt.flowersCollected++,Jt.log(ee.collected,Jt.flowersCollected+"/"+Jt.options.flowersNeeded),Jt.flowersCollected==Jt.options.flowersNeeded&&Jt.log(ee.collected_all),Jt.flowersCollected>=Jt.options.flowersNeeded&&Jt.flowersCollected%2==0&&Jt.log(ee.collected_even)),"b"==e.symbol&&Jt.allFlowersCollected()&&Jt.end()):this.leaveScent()},t.prototype.die=function(){if(this.alive=!1,Jt.scheduler.remove(this),this.tile().mob=null,new St.PreciseShadowcasting(function(t,e){return!Jt.safeAt([t,e]).opaque}).compute(this.at[0],this.at[1],3,function(t,e,i,n){var s=Jt.at([t,e]);" "==s.symbol&&(s.symbol="*",s.cost+=2)}),console.log(this),console.log("dies"),this.isPlayer())return this.lookAround(),Jt.draw(),Jt.complete=!0,void Jt.engine.lock();Jt.player.hate=0,Jt.seeingRed=!1,Jt.log(ee.death),this.isPlayer()||Jt.killed++},t.prototype.leaveScent=function(){var t=Jt.at(this.at);t.mob=this,t.scent<=.01&&Jt.scent.push(t),t.scent=.5+Math.min(1,this.fear/100)},t.prototype.findNearestMob=function(){return Jt.mobs.map(function(t){return{mob:t,d:!t.isPlayer()&&t.alive&&t.at?oe(t.at,Jt.player.at):1e6}}).reduce(function(t,e){return e.d<t.d?e:t},{mob:null,d:1e6}).mob},t.prototype.pathFinderUsed=function(){return this.isPlayer()||this.isGuard()||this.fear<30||!this.tile().visible?Jt.pathfinder:Jt.escapefinder},t.prototype.findPathTo=function(t){var e=this.pathFinderUsed().find(this.at,t);return e&&e.shift(),e},t.prototype.reroute=function(){this.hasPath()&&(this.path=this.pathFinderUsed().find(this.at,this.path.pop()))},t.prototype.seesOthers=function(){for(var t=0,e=this.sees;t<e.length;t++){var i=e[t],n=Jt.at(i);if(n.mob&&n.mob!=this)return n.mob}return null},t.prototype.waiting=function(){return this.path&&this.path[0]&&this.path[0][0]==this.at[0]&&this.path[0][1]==this.at[1]},t.prototype.playerAct=function(){if(Jt.seeingRed){this.stop();var t=this.findNearestMob();if(t){var e=this.findPathTo(t.at);e[0]&&this.goTo(e[0])}}else if(this.path){if(this.stopWhenMeetEnemies(),this.hasPath()||this.stop(),!this.hasPath())return!1;this.waiting()?this.stay():this.goTo(this.path.shift())}else{var i=Jt.lastKey;if(delete Jt.lastKey,!(i in Dt))return!1;var n=Dt[i];if(-1==n)this.stay();else{var s=-1==n?[0,0]:mt[8][n],o=[this.at[0]+s[0],this.at[1]+s[1]];if(Jt.at(o).cost>1e3)return!1;this.goTo(o)}}return this.lookAround(),!0},t.prototype.setPath=function(t){this.path=this.findPathTo(t)},t.prototype.mobAct=function(){if(this.isGuard()&&(this.fear=0,this.at&&Jt.player.seesEnemies&&this.setPath(Jt.player.at)),this.path&&this.path.length>0){if(this.tile().visible&&(this.path=this.findPathTo(this.path.pop())),this.path&&this.path.length>0&&this.goTo(this.path.shift()),!this.alive)return;var t=this.tile();"*"==t.symbol&&(this.fear+=5),"<"!=t.symbol||this.hasPath()||this.leave()}else{this.path=[];var e=void 0;e=z.getUniform()<Jt.options.despawn+Math.max(0,this.fear-60)/100?z.getItem(Jt.exits):z.getItem(Jt.landmarks),this.path=this.findPathTo(e)}},t.prototype.leave=function(){this.tile().mob=null,this.at=null,this.path=null,Jt.panic+=this.fear,Jt.log("escaped",Jt.panic.toFixed(2))},t.prototype.stay=function(){this.concentration++,this.isPlayer()&&this.concentration>5&&0==this.hate&&Jt.alertOnce("calm"),this.changeHateBy(-.5)},t.prototype.changeHateBy=function(t){this.hate=Math.min(Math.max(0,this.hate+t),100),this.hate>=25&&Jt.alertOnce("rage"),this.hate>=50&&Jt.alertOnce("rage_more")},t.prototype.stopWhenMeetEnemies=function(){var t=this.seesOthers();t&&!this.seesEnemies&&this.hasPath()&&(this.stop(),Jt.alertOnce("mob_first_"+t.type),new ae([t.at[0],t.at[1]-1],2,{duration:500,interval:100})),this.seesEnemies=!!t},t.prototype.tooltip=function(){if(this.isPlayer())return[ee.me];if(this.type>1)return[ee["mob_"+this.type]];var t=this.fear<30?null:this.fear<60?ee.mob_wary:this.fear<100?ee.mob_afraid:ee.mob_fleeing;return t?[ee.mob,t]:[ee.mob]},t.prototype.lookAtMe=function(){var e=Jt.player.hate/10+(Jt.seeingRed?10:0);e*=1+Jt.killed,this.fear<60&&this.fear+e>=60&&(Jt.log(ee.mob_startled),this.emote="!"),this.fear<100&&this.fear+e>=100&&(Jt.log(ee.mob_flees),this.emote="⚡"),this.fear+=e,this.type==t.ELDER&&0==Jt.killed&&oe(this.at,Jt.player.at)<=3&&Jt.end(ee.ending_true)},t.prototype.lookAround=function(){for(var t=this,e=0,i=this.sees;e<i.length;e++){var n=i[e];Jt.at(n).visible=0}for(var s=-4;s<=4;s++)for(var o=-4;o<=4;o++){var r=Jt.safeAt([this.at[0]+s,this.at[1]+o]);r!=Jt.emptyTile&&(r.seen=1)}var a=new St.PreciseShadowcasting(function(t,e){return!Jt.safeAt([t,e]).opaque});this.sees=[];var l=Jt.seeingRed?-.3:-.2,h=!1,c=!1;a.compute(this.at[0],this.at[1],20,function(e,i,n,s){t.sees.push([e,i]);var o=Jt.at([e,i]);"⚘"==o.symbol&&n<=10&&(h=!0),o.mob&&!o.mob.isPlayer()&&(o.mob.lookAtMe(),c=!0,Jt.alertOnce("mob_first_"+o.mob.type),l+=10/(n+3)),o.visible=s*(20-n)/20,o.seen=1}),this.tile().scent>.1&&(l+=2*this.tile().scent,Jt.alertOnce("smell_first")),h&&(Jt.alertOnce("flower_first"),l>0?(Jt.alertOnce("flower_mob_first"),l*=2):l+=-3),this.changeHateBy(Math.min(10,l*Jt.options.hateGain)),Jt.letterRead<Jt.flowersCollected&&!c&&(z.getUniform()<.1&&0==this.hate||h)&&Jt.readNextLetter();var d=Jt.seeingRed;(z.getUniform()<.3||100==Jt.player.hate||0==Jt.player.hate)&&(Jt.seeingRed=(this.hate-50)/50>z.getUniform(),d!=Jt.seeingRed&&Jt.log(Jt.seeingRed?ee.seeing_red:ee.seeing_red_end)),Jt.escapefinder.setGridFear()},t.prototype.hasPath=function(){return this.path&&this.path.length>0},t.prototype.stop=function(){this.path=null},t.prototype.sym=function(){return["☺","☻","g","G","e"][this.type]},t.prototype.fg=function(){if(this.isPlayer()){if(Jt.seeingRed)return"red";var e=Math.min(200,20*Jt.killed);return Lt.toRGB([255,255-e,255-e])}if(this.isGuard())return this.type==t.BLUE_ONI||this.type==t.ELDER&&0==Jt.killed?"white":"red";var i=Math.max(128,255-this.fear);return Lt.toRGB([255,i,i])},t.prototype.actFixedInterval=function(){},t.MOB=0,t.PLAYER=1,t.BLUE_ONI=2,t.RED_ONI=3,t.ELDER=4,t}(),Nt=function(){this.pointsToAvoid={},this.startX,this.callback,this.startY,this.endX,this.endY,this.nodeHash={},this.openList},Wt=function(t,e,i,n,s){this.parent=t,this.x=e,this.y=i,this.costSoFar=n,this.simpleDistanceToTarget=s,this.bestGuessDistance=function(){return this.costSoFar+this.simpleDistanceToTarget}},Ft="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function Bt(t,e){return t(e={exports:{}},e.exports),e.exports}var Gt=Bt(function(t,e){(function(){var e,i,n,s,o,r,a,l,h,c,d,u,f,p,g;n=Math.floor,c=Math.min,i=function(t,e){return t<e?-1:t>e?1:0},h=function(t,e,s,o,r){var a;if(null==s&&(s=0),null==r&&(r=i),s<0)throw new Error("lo must be non-negative");for(null==o&&(o=t.length);s<o;)r(e,t[a=n((s+o)/2)])<0?o=a:s=a+1;return[].splice.apply(t,[s,s-s].concat(e)),e},r=function(t,e,n){return null==n&&(n=i),t.push(e),p(t,0,t.length-1,n)},o=function(t,e){var n,s;return null==e&&(e=i),n=t.pop(),t.length?(s=t[0],t[0]=n,g(t,0,e)):s=n,s},l=function(t,e,n){var s;return null==n&&(n=i),s=t[0],t[0]=e,g(t,0,n),s},a=function(t,e,n){var s;return null==n&&(n=i),t.length&&n(t[0],e)<0&&(e=(s=[t[0],e])[0],t[0]=s[1],g(t,0,n)),e},s=function(t,e){var s,o,r,a,l,h;for(null==e&&(e=i),l=[],o=0,r=(a=function(){h=[];for(var e=0,i=n(t.length/2);0<=i?e<i:e>i;0<=i?e++:e--)h.push(e);return h}.apply(this).reverse()).length;o<r;o++)s=a[o],l.push(g(t,s,e));return l},f=function(t,e,n){var s;if(null==n&&(n=i),-1!==(s=t.indexOf(e)))return p(t,0,s,n),g(t,s,n)},d=function(t,e,n){var o,r,l,h,c;if(null==n&&(n=i),!(r=t.slice(0,e)).length)return r;for(s(r,n),l=0,h=(c=t.slice(e)).length;l<h;l++)o=c[l],a(r,o,n);return r.sort(n).reverse()},u=function(t,e,n){var r,a,l,d,u,f,p,g,m;if(null==n&&(n=i),10*e<=t.length){if(!(l=t.slice(0,e).sort(n)).length)return l;for(a=l[l.length-1],d=0,f=(p=t.slice(e)).length;d<f;d++)n(r=p[d],a)<0&&(h(l,r,0,null,n),l.pop(),a=l[l.length-1]);return l}for(s(t,n),m=[],u=0,g=c(e,t.length);0<=g?u<g:u>g;0<=g?++u:--u)m.push(o(t,n));return m},p=function(t,e,n,s){var o,r,a;for(null==s&&(s=i),o=t[n];n>e&&s(o,r=t[a=n-1>>1])<0;)t[n]=r,n=a;return t[n]=o},g=function(t,e,n){var s,o,r,a,l;for(null==n&&(n=i),o=t.length,l=e,r=t[e],s=2*e+1;s<o;)(a=s+1)<o&&!(n(t[s],t[a])<0)&&(s=a),t[e]=t[s],s=2*(e=s)+1;return t[e]=r,p(t,l,e,n)},e=function(){function t(t){this.cmp=null!=t?t:i,this.nodes=[]}return t.push=r,t.pop=o,t.replace=l,t.pushpop=a,t.heapify=s,t.updateItem=f,t.nlargest=d,t.nsmallest=u,t.prototype.push=function(t){return r(this.nodes,t,this.cmp)},t.prototype.pop=function(){return o(this.nodes,this.cmp)},t.prototype.peek=function(){return this.nodes[0]},t.prototype.contains=function(t){return-1!==this.nodes.indexOf(t)},t.prototype.replace=function(t){return l(this.nodes,t,this.cmp)},t.prototype.pushpop=function(t){return a(this.nodes,t,this.cmp)},t.prototype.heapify=function(){return s(this.nodes,this.cmp)},t.prototype.updateItem=function(t){return f(this.nodes,t,this.cmp)},t.prototype.clear=function(){return this.nodes=[]},t.prototype.empty=function(){return 0===this.nodes.length},t.prototype.size=function(){return this.nodes.length},t.prototype.clone=function(){var e;return(e=new t).nodes=this.nodes.slice(0),e},t.prototype.toArray=function(){return this.nodes.slice(0)},t.prototype.insert=t.prototype.push,t.prototype.top=t.prototype.peek,t.prototype.front=t.prototype.peek,t.prototype.has=t.prototype.contains,t.prototype.copy=t.prototype.clone,t}(),t.exports=e}).call(Ft)}),Ht={};var Ut=Ht,Xt=1;Ht.js=function(){var t,e,i,n=!1,s={},o={},r={},a={},l=!0,h={},c=[],d=Number.MAX_VALUE,u=!1;this.setAcceptableTiles=function(t){t instanceof Array?i=t:!isNaN(parseFloat(t))&&isFinite(t)&&(i=[t])},this.enableSync=function(){n=!0},this.disableSync=function(){n=!1},this.enableDiagonals=function(){u=!0},this.disableDiagonals=function(){u=!1},this.setGrid=function(e){t=e;for(var i=0;i<t.length;i++)for(var n=0;n<t[0].length;n++)o[t[i][n]]||(o[t[i][n]]=1)},this.setTileCost=function(t,e){o[t]=e},this.setAdditionalPointCost=function(t,e,i){void 0===r[e]&&(r[e]={}),r[e][t]=i},this.removeAdditionalPointCost=function(t,e){void 0!==r[e]&&delete r[e][t]},this.removeAllAdditionalPointCosts=function(){r={}},this.setDirectionalCondition=function(t,e,i){void 0===a[e]&&(a[e]={}),a[e][t]=i},this.removeAllDirectionalConditions=function(){a={}},this.setIterationsPerCalculation=function(t){d=t},this.avoidAdditionalPoint=function(t,e){void 0===s[e]&&(s[e]={}),s[e][t]=1},this.stopAvoidingAdditionalPoint=function(t,e){void 0!==s[e]&&delete s[e][t]},this.enableCornerCutting=function(){l=!0},this.disableCornerCutting=function(){l=!1},this.stopAvoidingAllAdditionalPoints=function(){s={}},this.findPath=function(e,s,o,r,a){var l=function(t){n?a(t):setTimeout(function(){a(t)})};if(void 0===i)throw new Error("You can't set a path without first calling setAcceptableTiles() on EasyStar.");if(void 0===t)throw new Error("You can't set a path without first calling setGrid() on EasyStar.");if(e<0||s<0||o<0||r<0||e>t[0].length-1||s>t.length-1||o>t[0].length-1||r>t.length-1)throw new Error("Your start or end point is outside the scope of your grid.");if(e!==o||s!==r){for(var d=t[r][o],u=!1,f=0;f<i.length;f++)if(d===i[f]){u=!0;break}if(!1!==u){var p=new Nt;p.openList=new Gt(function(t,e){return t.bestGuessDistance()-e.bestGuessDistance()}),p.isDoneCalculating=!1,p.nodeHash={},p.startX=e,p.startY=s,p.endX=o,p.endY=r,p.callback=l,p.openList.push(_(p,p.startX,p.startY,null,1));var g=Xt++;return h[g]=p,c.push(g),g}l(null)}else l([])},this.cancelPath=function(t){return t in h&&(delete h[t],!0)},this.calculate=function(){if(0!==c.length&&void 0!==t&&void 0!==i)for(e=0;e<d;e++){if(0===c.length)return;n&&(e=0);var s=c[0],o=h[s];if(void 0!==o)if(0!==o.openList.size()){var r=o.openList.pop();if(o.endX!==r.x||o.endY!==r.y)r.list=0,r.y>0&&f(o,r,0,-1,1*m(r.x,r.y-1)),r.x<t[0].length-1&&f(o,r,1,0,1*m(r.x+1,r.y)),r.y<t.length-1&&f(o,r,0,1,1*m(r.x,r.y+1)),r.x>0&&f(o,r,-1,0,1*m(r.x-1,r.y)),u&&(r.x>0&&r.y>0&&(l||p(t,i,r.x,r.y-1,r)&&p(t,i,r.x-1,r.y,r))&&f(o,r,-1,-1,1.4*m(r.x-1,r.y-1)),r.x<t[0].length-1&&r.y<t.length-1&&(l||p(t,i,r.x,r.y+1,r)&&p(t,i,r.x+1,r.y,r))&&f(o,r,1,1,1.4*m(r.x+1,r.y+1)),r.x<t[0].length-1&&r.y>0&&(l||p(t,i,r.x,r.y-1,r)&&p(t,i,r.x+1,r.y,r))&&f(o,r,1,-1,1.4*m(r.x+1,r.y-1)),r.x>0&&r.y<t.length-1&&(l||p(t,i,r.x,r.y+1,r)&&p(t,i,r.x-1,r.y,r))&&f(o,r,-1,1,1.4*m(r.x-1,r.y+1)));else{var a=[];a.push({x:r.x,y:r.y});for(var g=r.parent;null!=g;)a.push({x:g.x,y:g.y}),g=g.parent;a.reverse();var _=a;o.callback(_),delete h[s],c.shift()}}else o.callback(null),delete h[s],c.shift();else c.shift()}};var f=function(e,n,o,r,a){var l=n.x+o,h=n.y+r;if((void 0===s[h]||void 0===s[h][l])&&p(t,i,l,h,n)){var c=_(e,l,h,n,a);void 0===c.list?(c.list=1,e.openList.push(c)):n.costSoFar+a<c.costSoFar&&(c.costSoFar=n.costSoFar+a,c.parent=n,e.openList.updateItem(c))}},p=function(t,e,i,n,s){var o=a[n]&&a[n][i];if(o){var r=g(s.x-i,s.y-n);if(!function(){for(var t=0;t<o.length;t++)if(o[t]===r)return!0;return!1}())return!1}for(var l=0;l<e.length;l++)if(t[n][i]===e[l])return!0;return!1},g=function(t,e){if(0===t&&-1===e)return Ht.TOP;if(1===t&&-1===e)return Ht.TOP_RIGHT;if(1===t&&0===e)return Ht.RIGHT;if(1===t&&1===e)return Ht.BOTTOM_RIGHT;if(0===t&&1===e)return Ht.BOTTOM;if(-1===t&&1===e)return Ht.BOTTOM_LEFT;if(-1===t&&0===e)return Ht.LEFT;if(-1===t&&-1===e)return Ht.TOP_LEFT;throw new Error("These differences are not valid: "+t+", "+e)},m=function(e,i){return r[i]&&r[i][e]||o[t[i][e]]},_=function(t,e,i,n,s){if(void 0!==t.nodeHash[i]){if(void 0!==t.nodeHash[i][e])return t.nodeHash[i][e]}else t.nodeHash[i]={};var o=y(e,i,t.endX,t.endY);if(null!==n)var r=n.costSoFar+s;else r=0;var a=new Wt(n,e,i,r,o);return t.nodeHash[i][e]=a,a},y=function(t,e,i,n){var s,o;return u?(s=Math.abs(t-i))<(o=Math.abs(e-n))?1.4*s+o:1.4*o+s:(s=Math.abs(t-i))+(o=Math.abs(e-n))}},Ht.TOP="TOP",Ht.TOP_RIGHT="TOP_RIGHT",Ht.RIGHT="RIGHT",Ht.BOTTOM_RIGHT="BOTTOM_RIGHT",Ht.BOTTOM="BOTTOM",Ht.BOTTOM_LEFT="BOTTOM_LEFT",Ht.LEFT="LEFT",Ht.TOP_LEFT="TOP_LEFT";var Yt={lang:"English",guide:'\n<span style="color:lightgrey">\nclick - move to cursor or stop<br/>\nclick self - wait<br/>\nNUMPAD keys - move around<br/>\nNum5, space - wait<br/>\nShift + 1-9: save<br/>\n1-9: load<br/>\nShift + R: restart<br/>\nShift + L: toggle language<br/>\nESC: toggle menu<br/>\n</span>\n',save:"Save",load:"Load",new_game:"New Game",continue:"Continue",saved_to:"Saved to {0}",loaded_from:"Loaded from {0}",no_save_in:"No save in {0}",me:"It's me. A regular everyday normal person.",flower:"A flower. Seeing it grow makes me calm. <br/> <span class='important'>I'll pick it for her.</span>",flower_first:"One of those weird red flowers <em>⚘</em> she is fond of. <span class='important'>I'll pick some for her.</span> \nShe said she wants them with roots.",flower_mob_first:"<em>How dares it ☺ to be near the flower ⚘ !</em>",collected:"I carefully dig out the flower <em>⚘</em> {0}",collected_all:"I have collected enough flowers. But she is nowhere to seen. <span class='important'>Maybe she is home already? I'll go check.</span>",collected_even:"Even number of flowers is believed to be connected with death. I hope she is not superstitious.",tree:"Thick forest.",exit:"The path to the village.",entrance:"The path back to the road.",blood:"A pool of blood. Why is it here?",blood_old:"Looks like a dried blood. Weird.",blood_trail:"A trail of blood. Quite old.",wall:"An old, but sturdy hut wall. She lives here.",mob:"Monster",mob_2:"Crafty monster. Fight it calmly.",mob_3:"Strong monster. Fight it furiously.",mob_4:"Elder",mob_first_0:"I see one of the monsters <span style='background:darkred;font-weight:bold;'>☺</span> that infest this forest. Alone they can't harm me, but they are dangerous in groups.",mob_first_2:"This monster is crafty. I should be very careful and <span class='important'>keep my calm</span> while fighting with it.",mob_first_3:"This monster is strong. But I'll overcome it if I <span class='important'>put all my hatred into the attack</span>.",mob_first_4:"It's... another monster. Right? I think I have seen it... him.. before. They call him Elder. \nLooks like it... he wants to tell me something. Can I trust him?",smell:"A trail of smell.",smell_first:"Those things smell \n<span style='background:#a00'>&nbsp;</span><span style='background:#800'>&nbsp;</span><span style='background:#600'>&nbsp;</span><span style='background:#400'>&nbsp;</span>\nquite bad. I can feel the trail of their stench from quite a far away.",calm:"After a moment of rest I feel my emotions calming a little and I get a better awareness of surroundings.",rage:"<span style='color:darkred'>Look and smell of those monsters raise a wave of rage in my heart.</span>",rage_more:"<em>I'm furious. I feel like I can snap at any moment.</em>",seeing_red:"<em>Waaargh!</em>",seeing_red_end:"What has just happened?",death:"<em>Splort.</em>",elder_angry:"So, here it is <em>e</em>. The one that I hate the most. And the one I have no chance to defeat. My only option is to run.",elder_lose:"The fight with the elder monster ends at the instant. I am as helpless against it as ordinary monsters are against me.",blue_victory:"I carefully dodged it's lunge and then made a precise killing strike.",blue_lose:"I charged monster only to be skewered with a fast stab.",red_victory:"I overwhelm it's defences with a stream of furious attacks.",red_lose:"The monster blocks most of my attacks and shrug off the others. And then deals one, but powerful attack.",lose:"<span class='important'>I collapse to never stand up again.<br/><br/>GAME OVER</span><br/><br/>\nTip: Guards (marked with G and g) are attracted by kills. Your chances to defeat them in fight depends on your fury level (red bar at the top). \nYou need as much as possible of it for G, and opposite for g.<br/><br/>\nPress Escape to continue.",win_tip:"Ending you get depends on how many flowers you collect (odd or even) and how many kills committed. \nThere is also a secret ending, but getting it would require restraint and patience.",not_here:"She is not here. Probably somewhere in the forest picking up herbs again. <span class='important'>I'll  go look for her.</span>",mob_wary:"It stares at me warily.",mob_afraid:"It covers in fear.",mob_fleeing:"It flees to it's lair screaming.",mob_startled:"☺ avoids me.",mob_flees:"☺ runs away.",game_complete:"GAME COMPLETE",grave:"A grave. Seems to be recent.",escaped:"Monster has escaped. Panic level: {0}",read_letter:["Still no signs of her. Oh, right, I still have her letter. Maybe reading it will give some clues? I started reading:","I have decided to continue reading the letter:","Still can't find her. Maybe she is in the village? I'll continue with the letter:","I'll read the remaining letter part:"],close_letter:["My sight has suddenly blurred, making seeing writing difficult. I will continue reading next time.","Is she trying to be a philosopher here? Not my cup of tea. I'll better continue looking for her.","It was painful to reading it. And impossible not to. I'll read the rest, just not now.","It was all. I stand for a while looking at the letter blankly.  If she'd only know... "],letter:["\nI had an opportunity to pass you this letter, I hope it will reach you. I will explain this 'opportunity' later.\n\nI'm well, more or less, hope you are too. I have made some progress with my research, but not much. \nI have not yet found the cure, or even the cause of Strangling disease yet, but got some leads.\nLocals have a different name for this disease: Forest Cough. And indeed, symptoms are much more prominent \nwith those that are going to forest often. Which is the most of the village. They had very poor harvest last year, \nand a big chunk of it was looted. So, villagers have to look for food everywhere.\nYou would not find a living animal or unpicked edible berry or mushroom for a mile around the village by now.\n","\nI try to help them with what I can, but it's not much.\nI perform surgery on occasion, used the medicine I brought from the city, some local herbs.\nBut villagers rarely ask me for help. They don't trust the \"outsider\" and I can't blame them. \nThese days outsider is too often a brigand, a thief or a rapist. People kill each other for a loaf of bread.\nFear, despair and hate are diseases that flood the land. Diseases that are way more fatal than Strangling.\nAnd, unlike Strangling, they are definitely contagious. Sadly, ailness of spirit are not my major. \nLet's hope I am at least qualified to cure the bodies.\n",'\nI have even heard a rumors about cannibalism. Only rumors yet. \nAt least I know for sure that locals bury their dead properly. I know it, because I wanted to do some autopsy.\nBut the Elder forbid me to even rise the question. \nAnd he is right, some people see me as a "witch" already, I don\'t want to add any more to my "spookiness".\nI\'m really afraid, you know. Life values so little here, mine included. Villagers tolerate me so far, but fear or desperation \ncan push them over the edge any moment. And instead of as "weird woman in the forest hut" they\'ll see me as a witch that that spoils their crops. \nOr a food. I\'d leave already, but travelling to capital is even more dangerous now than staying. And I still hope to find something about the disease.\n','\nWell, yes, about the "Forest Cough". Giving the leads I have, I naturally suspect that something in the forest causes the disease.\nThough it\'s hard to find which "something". It can be animal, insect, maybe even plant? Or some microscopic organism. \nI keep looking for it, but nothing of note so far.\nBut I have found something else - this kid that I send this letter with. \nHe was lying on the outskirts of village, beaten half to death. \nGiven that I have never seen him there before, he is probably some refugee or deserter that was either a victim of robbery, \nor a robber beaten by his would-be victims. Given that he would not want to talk about this, probably latter.\nAs you can guess, I patched him up and was hiding him for couple of weeks until he recovered. \nThen I figured it\'s a chance to pass you a letter. Hopefully he will not ditch it the moment he leaves my sight.\nI said him you can give him some work, so please consider it. He seems to be bright enough. I have caught him once reading my medical notes, \nso he can read. I considered leaving with him, but I do not trust him enough yet.\n'],ending_denial:'\nIt\'s her! She smiles at me.\n<div class="she">\nOh, you have picked the flowers! How nice of you. I have a good news. \nDo you remember me dreaming of finding a way to cure evil in people? I have found it!\nIt\'s these very flowers fragrance. It works slow, but inhaling it for a long time will destroy the evil in people completely!\nWould you please plant them around the village for me? \n</div>\n<div class="ending-type">Ending 1/5: Denial.</div>\n',ending_anger:'\nOf cause, she is not here. Who would survive after losing so much blood. Who killed her? Villagers? Looters? Does it matter?\nShe is not in this world anymore. All that remained of her is a huge, painful hole in my soul.\nWhy is it there? Why do I miss her so much? I have lived for many years without knowing of her existance, why do I need her so much now?\nOr maybe, I always missed her, just did not know it. And because of that I was always in pain so big, I only could manage by throwing it at others.\n<br/><br/>\nWould explain a lot, wouldn\'t it?\n<div class="ending-type">Ending 2/5: Anger.</div>\n',ending_bargain:'\n<div class="you">You are dead, aren\'t you?</div>\n\n<div class="she">My body is, looks like.</div>\n\n<div class="you">Your body? Is there anything else? I\'m not religious. And even if I were, your soul is not here anymore. God has stolen it from me.</div>\n\n<div class="she">But there are still things I have done. People I have healed. Memories of me. \nMemories of us are what makes us us, aren\'t they? Even if my body can\'t hold memories of me anymore, yours can.</div>\n\n<div class="you">You want to say that memories of you will make me you?</div>\n\n<div class="she">Ha ha, yes, to an extent. Do you not want it?</div>\n\n<div class="you">Beats being me, I guess. Do you think I can manage? Be as smart, caring and selfless like you? \nKeep helping people, even though they can kill me for that? I\'ll never fill the hole you left in the world. Or the hole you have left in my heart.</div>\n\n<div class="she">Not all the way. But maybe a bit. Will you do it?</div>\n\n<div class="ending-type">Ending 3/5: Bargain.</div>\n',ending_depression:"\nOf cause, she is not here. This blood must be hers. The stash with her books and research is all here. She would not leave without it.\nLooks like her fears did materialise. \n<br/><br/>\nLooking through her notes, I have found a theory about Strangling's cause. She thinks it's all these flowers I have collected. \nThey cause an allergy that slowly, by steadily makes people's lungs unusable. \nGood thing is these flowers are quite picky about their environment. They grow only in dark dump places, and do not spread too much.\nSo it would not be difficult to weed them out around settlements. \nI'll show this to doctors in city. Maybe this time I will even find the one she has sent the letter to.\n<div class=\"ending-type\">Ending 4/5: Depression/Acceptance.</div>\n",ending_true:'\nA mons... person that I have recognized as the village\'s Elder approaches me.\n\n<div class="elder">\nSo, you are that kid with crazy eyes lurking in the forest I keep hearing about.\nAre you looking for the healer woman? She is not living there anymore. \nSome brigand tried to rob her and slashed her with a knife when she cried out. We came to help, but she has lost a lot of blood.\nMy wife is looking after her at our house until she gets better.  I can take you to her.\n</div>\n\nI don\'t trust him. But.. Maybe it\'s true? Would make sense. Such a simple explanation. Probably I should have not assume she is dead so soon.\nI came with the Elder and then...\n\nIt\'s her! Very pale, but alive. She smiles at me weakly. \n\n<div class="she">Ah... God! I turned out to be such a damsel in distress.</div>\n<div class="ending-type">Ending 5/5: Sometimes You Get Lucky.</div>\n'},$t={lang:"Русский",guide:'\n<span style="color:lightgrey">\nЛКМ - движение или остановка<br/>\nЛКМ на себя - ждать<br/>\nNUMPAD - движение<br/>\nNum5, пробел - ждать<br/>\nShift + 1-9: сохранение<br/>\n1-9: загрузка<br/>\nShift + R: начать заново<br/>\nShift + L: переключить язык<br/>\nESC: меню<br/>\n</span>\n',save:"Сохранить",load:"Загрузить",new_game:"Новая Игра",continue:"Продолжить",saved_to:"Сохранено в {0}",loaded_from:"Загружено из {0}",no_save_in:"Нет сохранения в {0}",me:"Это я. Обыкновенный ничем не примечательный человек.",flower:"Цветок. Его вид меня успокаивает.<br/> <span class='important'>Я выкопаю его для неё.</span>",flower_first:"Один из этих странных красных цветков <em>⚘</em>, которые ей нравятся. <span class='important'>Я соберу несколько штук для неё.</span> \nОна просила не повредить корни.",flower_mob_first:"<em>Как он ☺ смеет приближаться к цветку ⚘ !</em>",collected:"Я аккуратно выкопал цветок <em>⚘</em> {0}",collected_all:"Я собрал достатончо цветов. но её нет и следа. <span class='important'>может, она уже дома? Пойду проверю.</span>",collected_even:"Четное число цыетов не принято дарить живым людям. Надеюсь, она не суеверная.",tree:"Дремучий лес.",exit:"Тропинка к деревне.",entrance:"Путь обратно на тракт.",blood:"Лужа крови. Откуда она тут?",blood_old:"Похоже на засохнувшую кровь. Странно",blood_trail:"Кровавый след. Довольно старый",wall:"Старая, но крепкая избушка. Она живет тут.",mob:"Чудовище",mob_2:"Ловкое чудовище. Требуется спокойствие и расчет.",mob_3:"Сильный монстр. Надо бить его изо всех сил.",mob_4:"Старейшина.",mob_first_0:"Одно из чудовищ <span style='background:darkred;font-weight:bold;'>☺</span>, наводнивших эти леса. В одиночку не особо опасно.",mob_first_2:"Ловкая тварь. Я должен быть очень осторожным и <span class='important'>сдерживать мою ярость</span>, когда дерусь с ним.",mob_first_3:"Огромный монстр. У него тослстая шкура, но я смогу пробить ее, если <span class='important'>вложу в атаку всю мою ярость.</span>.",mob_first_4:"Это... ведь чудовище, да? Мне кажется, я видел это... его... раньше. Кажется, его называли Старейшиной. \nПохоже, оно... он пытается мне что-то сказать. Могу ли я ему доверять?",smell:"Пахучий шлейф.",smell_first:"Эти твари пахнут\n<span style='background:#a00'>&nbsp;</span><span style='background:#800'>&nbsp;</span><span style='background:#600'>&nbsp;</span><span style='background:#400'>&nbsp;</span>\nотвратительно. Я могу унюхать вонючий шлейф издалека.",calm:"Немного отдохнув, я успокоился и огляделся.",rage:"<span style='color:darkred'>Вид и даже запах этих тварей вызывают во мне ярость.</span>",rage_more:"<em>Я взбешен. В любой моент могу сорваться.</em>",seeing_red:"<em>ААААААА!</em>",seeing_red_end:"Что этоб было?",death:"<em>Чпок.</em>",elder_angry:"Вот он <em>e</em>. Тот, кого я больше всех ненавижу. И кого мне не победить. Остается только бежать.",elder_lose:"Бой с древним монстром окончился не успев начаться. Он несравнимо лучший боец, чем я.",blue_victory:"Я аккуратно увернулся от его атаки и нанес точный удар.",blue_lose:"Я бросился на него, но напоролся на молниеносный укол.",red_victory:"Чудовище ошеломлено моими яростными атаками.",red_lose:"Мои удары слишком слабы против него. А его собственный мощный удар вминает меня в землю.",lose:"<span class='important'>Я падаю и у же не подымаюсь.<br/><br/>ИГРА ОКОНЧЕНА</span><br/><br/>\nПодсказка: Стражи (G и g) появляются, если Вы совершаете убийства. Результат боя с ними зависит от шкалы Ярости (вверху экрана)-\nеё нужно иного для G и мало для g<br/><br/>\nНажмите Escape для продолжения.",win_tip:"Концовка зависит от количества собранных цветов (четное или нечетное) и количества убийств.\nТакже есть секретная концовка, доступная самым терпеливым и сдержанным.",not_here:"Её тут нет. Наверное, опять где-то в лесу собирает цветы. <span class='important'>Пойду поищу её.</span>",mob_wary:"Оно смотрит на меня с подозрением.",mob_afraid:"Оно дрожит от страха.",mob_fleeing:"Оно удирает, визжа от ужаса.",mob_startled:"☺ избегает меня.",mob_flees:"☺ убегает.",game_complete:"ИГРА ОКОНЧЕНА",grave:"Свежая могила.",escaped:"Чудовище сбежало. Уровень паники: {0}",read_letter:["Её все не видно. О, у меня ведь осталось её письмо. Может быть, из него я что-то пойму? Я начинаю чтение:","Я продолжил читать письмо:","Я её все еще не нашёл. Может, она в деревне? Продолжу читать письмо:","Дочитываю письмо:"],close_letter:["Перед глазами плывет. Продолжу читать потом.","Опять она философствует? Никогда этого не понимал. Лучше вернусь к поискам.","Мне больно это читать. Закончу потом.","Это всё. Я смотрю на письмо в задумчивости. если бы она только знала... "],letter:['\nПосылаю тебе это письмо с оказией. Об "оказии" раскажу подробнее потом.\n\nЯ в порядке, более или менее, надеюсь, ты тоже. Были некоторые подвижки в моем исследовании.\nЯ пока так и не нашла метод лечения, или даже причину болезни. Но появились кое-какие зацепки.\nУ местных есть особое название для этой болезни - Лесной Кашель. И, действительно, чаще всего \nоно встречается у тех, кто часто бывает в лесу. Т.е. у большинства жителей деревни. \nУ них был плохой урожай, к тому же часть из него была растащена. Так что они ищут еду где могут.\nНа расстоянии мили вокруг деревни уже не найти ни животного, ни несобранного гриба или ягоды.\n','\nЯ помогаю им чем могу, но получается сделать немного. Мне приходилось тут оперировать, применять лекарства,\nкоторые я привезла с собой из города, кое-что удалось использовать из местных трав.\nНо о помощи просят редко. Они не доверяю "чужакам" и я их за это не виню.\nВ наше время чужак - это слишком часто вор, грабитель или насильник. Люди убивают друг друга за буханку хлеба.\nЛюди заражены страхом, отчаянием и злобой - болезнями более смертельными и заразными чем любая из тех, что мы лечим.\nЖаль, что лечить болезни духа нас на медицинском не учили. Так что остается сосредоточится на лечении тел.\n','\nДо меня даже доходили слухи о каннибализме. Пока только слухи.\nПо крайней мере, я знаю, что местые своих мертвых хоронят как следует. Мне даже не разрешили сделать аутопсию.\nСтароста запретил даже думать об этом. И он прав, меня и так кое-кто тут называет "ведьмой".\nЗнаешь, мне действительно страшно. Жизнь здесь цениться так мало. И моя в том числе.\nКрестьяне меня терпят, но кто знает, к чему их может привести страх или отчаяние.\nИ вместо "странной тетки в лесу" они действительно могут посчитать меня ведьмой, которая портит посевы. Или едой.\nЯ бы уже уехала, но на дорогах сейчас еще опаснее, чем здесь. К тому же, я все еще надеюсь найти как лечить это болезнь.\n',"\nДа, насчет неё. Исходя из того, что я сказала в начале письма, причину болезни стоит искать в лесу.\nНо что именно искать? Это может быть животное, насекомое, может даже растение. Или какой-нибудь микроб. Хорошо, что я прихватила микроскоп....\nПока что ничего не нашла. Ну, кроме этого паренька, с которым я послала тебе письмо.\nОн валялся на краю деревни, избитый до полусмерти.\nЯ его тут раньше не видела, так что он, видимо, один из бродящих по округе дезертов или беженцев. \nМожет, его избил грабитель, а может, он сам попытался что-то украсть и попался.\nСам он на эту тему говорить не хочет и деревенских избегает, так что второе вполне вероятно.\nКак ты догадываешься, я его залатала и прятала пару недель, пока он не оклемался.\nА потом решила послать его к тебе с письмом. Надеюсь, он не выбросит его за первым поворотом.\nЯ сказала ему, что у тебя может быть для него работа, так что подумай об этом. Вроде, он неглупый парень.\nЯ даже как-то поймала его за чтением моих записей, так что читать он точно умеет.\nМожет, я бы и сама с ним отправилось, но я все-таки не настолько ему доверяю.\n"],ending_denial:'\nЭто она! Смотрит на меня с улыбкой.\n<div class="she">\nО, ты собрал цветы! Как мило. А у меня хорошие новости.\nПомнишь, я мечтала о том, чтобы найти лекарство от зла? Я его нашла!\nЭто запах этих цветов! Он действует медленно, но если долго его вдыхать, то он полностью уничтожит зло в любом человеке!\nНе мог бы ты посадить эти цветы вокруг деревни?\n</div>\n<div class="ending-type">Окончание 1/5: Отрицание.</div>\n',ending_anger:'\nРазумеется, её тут нет. Кто выживет после потери такого количества крови?\nКто убил ее? Деревенские? Грабители? Какая разница...\nЕё больше нет. все, что осталось - зияющая пустота в моей душе.\nОткуда это? Почему мне её так не хватает? Я прожил так долго не зная о её существовании, почему она так нужна мне сейчас?\nБыть может, она всегда была нужна мне, я просто не знал этого. И боль от того, что её не было со мной,\nбыла такой сильной, что я мог выдержать её, только выплескивая наружу.\n<br/><br/>\nЭто многое бы объяснило...\n<div class="ending-type">Окончание 2/5: Гнев.</div>\n',ending_bargain:'\n<div class="you">Ты мертва, так?</div>\n\n<div class="she">Моё тело, похоже, да.</div>\n\n<div class="you">А разве есть что-то ещё? Я не религиозен. И даже если бы я верил в вечную жихнь, твоей души тоже уже нет со мной.\nБог украл её у меня.</div>\n\n<div class="she">Но еще остались дела, что я сделала. Люди, которым я помогла. Воспоминания обо мне.\nВоспоминания - это то, что делает нас такими, какими мы есть, так ведь? Мой тело не может уже вместить воспоминания обо мне,\nно твоё может.</div>\n\n<div class="you">Ты хочешь сказать, что воспоминания о тебе сделать меня тобой?</div>\n\n<div class="she">Ха ха, в какой-то мере. Ты хочешь этого?</div>\n\n<div class="you">Лучше, чем быть мной, наверное. Ты думаешь, у меня получится? Быть таким же умным и добрыым, как ты? \nПомогать людям, зная, что они однажды могут меня за это убить? Я никогда не миогу заполнить дыру, которую ты оставила.\n</div>\n\n<div class="she">Полностью, наверное, нет. Но может быть, хотя бы частично. Ты сделаешь это?</div>\n\n<div class="ending-type">Окончание 3/5: Торг.</div>\n',ending_depression:'\nРазумеется, её тут нет. Это её кровь. И тайник с книгами и записями не тронут. Она никогда бы их не оставила.\nПохоже, один из её страхов стал реальностью.\n<br/><br/>\nПросмотрев её записи, я нашёл теорию о причинах болезни. Она думает, что она вызвана как раз теми цветами,\nкоторые я сейчас собирал. Они вызывают аллергию, которая медленно, но верно губит лёгкие.\nК счастью, эти цветы растут далеко не везде. Им нужно темное сырое место, и они распространяются довольно медленно.\nТак что будет нетрудно их выполоть. Покажу это врачам в городе. Может, ещё раз попробовать найти того, которому она отправляла письмо?\n<div class="ending-type">Ending 4/5: Depression/Acceptance.</div>\n',ending_true:'\nЧто-то... кто-то, в ком я узнаю старосту деревни подходит ко мне.\n\n<div class="elder">\nМне сказали что по лесу бродит ккой-то паренек с диким взглядом. Так это ты?\nТы, наверное, ищешь травницу? Она тут больше не живет.\nКакой-то бандит пытался её ограбить и ударил её ножом, когда она закричала. Мы прибежали на помощь, но она уже потеряла много крови.\nОна сейчас отлеживается у меня дома. Я могу проводить тебя к ней.\n</div>\n\nЯ не доверю ему. Но... Может быть, это правда? Звучит логично. Такое простое объяснение. Наверное, я слишком быстро решил, что случилось худшее.\nЯ последовал за старостой, и потом...\n\nЭто она! Очень бледная, но живая. Она слабо улыбается мне.\n\n<div class="she">Ах. Я, наверное, заставила тебя поволноваться.</div>\n<div class="ending-type">Окончание 5/5: Иногда чудеса случаются.</div>\n'},qt=function(){function t(t){this.interval=100,this.pressed={},this.subs=[],t.addEventListener("keydown",this),t.addEventListener("keyup",this),t.addEventListener("mousedown",this),t.addEventListener("mouseup",this)}return t.prototype.handleEvent=function(t){var e,i,n=this;t instanceof KeyboardEvent?(e=t.code,i="keydown"==t.type?"down":"up"):(e="Click"+t.button,i="mousedown"==t.type?"down":"up"),"down"==i&&(e in this.pressed||(this.click(e),this.pressed[e]=window.setInterval(function(){return n.click(e)},this.interval))),"up"==i&&(window.clearInterval(this.pressed[e]),delete this.pressed[e])},t.prototype.click=function(t){for(var e=0,i=this.subs;e<i.length;e++){(0,i[e])(t)}},t.prototype.sub=function(t){this.subs.push(t)},t.prototype.unsub=function(t){this.subs=this.subs.filter(function(e){return e!=t})},t.prototype.once=function(t){var e=this,i=function(n){e.unsub(i),t(n)};this.sub(i)},t.prototype.isPressed=function(t){return t in this.pressed},t.prototype.clear=function(){this.subs=[]},t}();function jt(t,i=e){let n;const s=[];function o(e){if(r(t,e)){if(t=e,!n)return;s.forEach(t=>t[1]()),s.forEach(e=>e[0](t))}}return{set:o,update:function(e){o(e(t))},subscribe:function(r,a=e){const l=[r,a];return s.push(l),1===s.length&&(n=i(o)||e),r(t),()=>{const t=s.indexOf(l);-1!==t&&s.splice(t,1),0===s.length&&n()}}}}const Vt=jt(0),Kt=jt({});var Jt,Qt=Lt.fromString("#180c24"),Zt=localStorage.russian,te=se(),ee=R({},te);for(var ie in ee)ee[ie]=ie;function ne(){Zt=!Zt,se()}function se(){for(var t in localStorage.russian=te,(te=Zt?$t:Yt).letter)te["complete_letter_"+t]=te.read_letter[t]+"<br/>***<br/>"+te.letter[t]+"<br/>***<br/>"+te.close_letter[t];return Kt.update(function(t){return te}),te}function oe(t,e){var i=t[0]-e[0],n=t[1]-e[1];return Math.sqrt(i*i+n*n)}var re=function(){function t(){}return t.prototype.serialise=function(){var t={};return Object.assign(t,this),t},t.prototype.deserialise=function(t){return Object.assign(this,t),this},t}(),ae=function(){function t(t,e,i){void 0===e&&(e=1),this.at=t,this.mode=e,this.options=i,this.run()}return t.prototype.run=function(){var t=this,e=this.options.duration||1e3,i=this.options.interval||50,n=e,s=window.setInterval(function(){var e;switch(n-=i,t.mode){case 1:e=n%250<150,Jt.drawAt(t.at,null,function(t){var i=t[0],n=t[1],s=t[2];return[e?i:" ",n,s]});break;case 2:e=n%400<200,Jt.drawAt(t.at,null,function(i){i[0],i[1];var n=i[2];return[t.options.symbol||"?",e?"red":"white",n]})}n<=0&&(Jt.drawAt(t.at),clearTimeout(s))},i)},t}(),le=function(){function t(){this.es=new Ut.js,this.es.setAcceptableTiles([1,2,3,4,5,6]),this.es.setTileCost(1,1),this.es.setTileCost(2,2),this.es.setTileCost(3,4),this.es.setTileCost(4,8),this.es.setTileCost(5,16),this.es.setTileCost(6,32),this.es.enableDiagonals(),this.es.enableCornerCutting(),this.es.enableSync()}return t.prototype.setGrid=function(){var t=Jt.grid.map(function(t){return t.map(function(t){return t.cost})});this.es.setGrid(t)},t.prototype.setGridFear=function(){for(var t=Jt.grid.map(function(t){return t.map(function(t){return t.cost})}),e=[[0,0],[0,0]],i=0;i<2;i++)e[i]=[Math.max(0,Jt.player.at[i]-16),Math.min(Jt.options.size[i],Jt.player.at[i]+16)];for(var n=e[0][0];n<e[0][1];n++)for(var s=e[1][0];s<e[1][1];s++)if(1==t[n][s]){var o=oe(Jt.player.at,[n,s]);t[n][s]=Math.max(1,7-Math.floor(Math.sqrt(o)))}this.es.setGrid(t)},t.prototype.find=function(t,e){var i;return this.es.findPath(t[1],t[0],e[1],e[0],function(t){i=t?t.map(function(t){return[t.y,t.x]}):[]}),this.es.calculate(),i},t}(),he=function(){function t(){}return t.prototype.getSpeed=function(){return 100},t.prototype.act=function(){Jt.time++,Jt.scent=Jt.scent.filter(function(t){return t.scent=Math.max(t.scent-.05,.01),t.scent>.01});for(var t=0,e=Jt.mobs;t<e.length;t++){(s=e[t]).actFixedInterval()}if(z.getUniform()<10*Jt.options.spawn/(100+Jt.panic)){var i=z.getItem(Jt.exits),n=Jt.at(i);if(!n.mob)(s=new zt).at=i.slice(),n.mob=s}Jt.guardsSpawned+1<=Math.min(Jt.panic/200,Jt.killed/2)&&(Jt.guardsSpawned++,(s=new zt(z.getUniform()<.5?zt.RED_ONI:zt.BLUE_ONI)).freeze=300,Jt.scheduler.add(s,!0));if(!Jt.elderSpawned&&0==Jt.killed&&Jt.panic>=Jt.options.elderSpawnAt){Jt.elderSpawned=!0;var s=new zt(zt.ELDER);Jt.scheduler.add(s,!0)}},t}(),ce=function(){function t(e){this.symbol=e,this.cost=1,this.opaque=!1,this.seen=0,this.visible=0,this.scent=0,this.cost=e.match(t.impassible)?1e6:1,this.opaque=!!e.match(t.impassible)}return t.prototype.serialise=function(){var t={};return Object.assign(t,this),delete t.mob,t},t.prototype.deserialise=function(t){return Object.assign(this,t),this.scent>.01&&Jt.scent.push(this),this},t.prototype.tooltip=function(t){if(!this.seen&&!this.scent)return null;if(this.mob)return this.mob.tooltip().map(function(t){return te[t]}).join("<br/>");switch(this.symbol){case"⚘":return te.flower;case"♠":return te.tree;case"<":return te.exit;case">":return te.entrance;case"*":return te.blood;case"b":return te.blood_old;case"B":return te.blood_trail;case"☨":return te.grave;case"#":return te.wall;case" ":if(this.scent>.1)return te.smell}},t.impassible=/[♠#]/,t}();function de(t,e){return[t[0]-e[0],t[1]-e[1]]}function ue(t,e){return t[0]==e[0]&&t[1]==e[1]}var fe=function(){return function(t){this.size=[80,80],this.mobs=18,this.flowers=6,this.hateGain=1,this.emptiness=.3,this.spawn=.1,this.despawn=.01,this.elderSpawnAt=100,Object.assign(this,t),this.flowersNeeded=this.flowersNeeded||this.flowers-1}}(),pe=function(){function t(){this.emptyTile=new ce("♠"),this.scent=[],this.mouseOver=[0,0],this.pathfinder=new le,this.escapefinder=new le,this.waitingForInput=!0,this.autoSaved=!0,this.paused=!1,this.displaySize=[45,45],this.mobs=[],this.seeingRed=!1,this.complete=!1,this.time=0,this._log=[],this.flowersCollected=0,this.letterRead=0,Jt=this,window.gameState=this}return t.prototype.serialise=function(){return{options:this.options,seeingRed:this.seeingRed,flowersCollected:this.flowersCollected,letterRead:this.letterRead,time:this.time,complete:this.complete,landmarks:this.landmarks,exits:this.exits,killed:this.killed,guardsSpawned:this.guardsSpawned,panic:this.panic,elderSpawned:this.elderSpawned,_log:this._log,milestones:this.milestones.serialise(),grid:this.grid.map(function(t){return t.map(function(t){return t.serialise()})}),mobs:this.mobs.map(function(t){return t.serialise()})}},t.prototype.deserialise=function(t){this.options=new fe(t.options),this.seeingRed=t.seeingRed,this.time=t.time,this.complete=t.complete,this.panic=t.panic,this.landmarks=t.landmarks,this.exits=t.exits,this.killed=t.killed,this.elderSpawned=t.elderSpawned,this.guardsSpawned=t.guardsSpawned,this.flowersCollected=t.flowersCollected,this.letterRead=t.letterRead,this._log=t._log,this.scent=[],this.milestones=(new re).deserialise(t.milestones),this.grid=t.grid.map(function(t){return t.map(function(t){return new ce(t.symbol).deserialise(t)})}),this.findFreeTiles(),this.mobs=t.mobs.map(function(t){return(new zt).deserialise(t)}),this.initMobs(),this.pathfinder.setGrid(),this.escapefinder.setGridFear(),this.waitingForInput=!0,this.draw()},t.prototype.at=function(t){return this.grid[t[0]][t[1]]},t.prototype.safeAt=function(t){return t[0]<0||t[1]<0||t[0]>=this.options.size[0]||t[1]>=this.options.size[1]?this.emptyTile:this.grid[t[0]][t[1]]},t.prototype.save=function(t){localStorage.setItem(t,JSON.stringify(Jt.serialise())),localStorage.setItem("!"+t,"yes"),"0"!=t&&Jt.log(ee.saved_to,t)},t.prototype.load=function(t){if(this.hasSave(t)){var e=localStorage.getItem(t);Jt.deserialise(JSON.parse(e)),Jt.log(ee.loaded_from,"0"==t?"autosave":t)}},t.prototype.hasSave=function(t){return!!localStorage.getItem("!"+t)},t.prototype.init=function(t){var e=this,i=this.d=new vt({width:t[0],height:t[1],fontSize:32,spacing:.6,forceSquareRatio:!0,bg:"#180C24",fontFamily:"Icons"});document.getElementById("game").appendChild(i.getContainer()),this.scheduler=new xt.Speed,this.engine=new Rt(this.scheduler),this.engine.start(),setInterval(function(){e.complete||e.autoSaved||(e.save("0"),e.autoSaved=!0)},1e3),window.addEventListener("keypress",function(t){return e.keypress(t)}),i.getContainer().addEventListener("mousedown",function(t){return e.onClick(t)}),i.getContainer().addEventListener("touchend",function(t){return e.onClick(t)}),i.getContainer().addEventListener("mousemove",function(t){return e.mousemove(t)}),this.keyboard=new qt(window),this.keyboard.sub(this.onKeyboard.bind(this))},t.prototype.start=function(t){this.options=new fe(t),z.setSeed(this.options.seed||Math.random()),this._log=[],this.mobs=[],this.complete=!1,this.killed=0,this.flowersCollected=0,this.panic=0,this.letterRead=0,this.time=0,this.guardsSpawned=0,this.seeingRed=!1,this.milestones=new re,this.elderSpawned=!1,this.generateMap(),this.initMobs(),this.draw()},t.prototype.addHut=function(){for(var t="         \n ####### \n #   s # \n # bb  # \n # bbbb# \n # bbb # \n ###b### \n    B    \n   B     ".split("\n"),e=t.length,i=this.player.at.slice(),n=0;n<e;n++)for(var s=t[n],o=s.length,r=0;r<o;r++){var a=s[r],l=new ce(a);this.grid[i[0]+r-4][i[1]+n-4]=l}},t.prototype.keypress=function(t){},t.prototype.drawAtDisplay=function(t,e){var i=de(t,this.deltaAndHalf().delta);ue(this.mouseOver,t)&&(e="#400"),this.d.draw(t[0],t[1],this.tileSym(i),this.tileFg(i),e||this.tileBg(i))},t.prototype.mousemove=function(t){var e=this.d.eventToPosition(t);if(e[1]<=0||e[1]>=this.displaySize[1]-1)this.tooltip=null;else{var i=de(e,this.deltaAndHalf().delta),n=this.safeAt(i);this.tooltip=n.tooltip(i);var s=this.mouseOver;this.mouseOver=e,this.drawAtDisplay(s),this.drawAtDisplay(this.mouseOver)}},t.prototype.initMobs=function(){this.scheduler.clear(),this.scheduler.add(new he,!0);for(var t=0,e=this.mobs;t<e.length;t++){var i=e[t];i.alive&&(i.at||i.isGuard())&&(this.scheduler.add(i,!0),i.at&&(this.at(i.at).mob=i))}},t.prototype.findFreeTiles=function(){var t=this;return this.freeTiles=[],this.eachTile(function(e,i){i.cost<1e3&&t.freeTiles.push(e)}),this.freeTiles},t.prototype.generateMap=function(){var t=this,e=this.options.size[0],i=this.options.size[1];this.grid=new Array(e).fill(null).map(function(t){return[]});var n=new Ot(e,i,{dugPercentage:this.options.emptiness,corridorLength:[2,6],roomWidth:[3,6],roomHeight:[3,6]});n.create(function(e,i,n){var s=n?"♠":" ";t.grid[e][i]=new ce(s)}),this.findFreeTiles();var s=n.getRooms(),o=z.shuffle(s);this.landmarks=s.map(function(t){return t.getCenter()}),this.exits=[[1e6,0],[-1e6,0]];for(var r=0,a=this.freeTiles;r<a.length;r++){var l=a[r];" "==this.at(l).symbol&&(l[0]<this.exits[0][0]&&(this.exits[0]=l),l[0]>=this.exits[1][0]&&(this.exits[1]=l))}this.at(this.exits[0]).symbol="<",this.at(this.exits[1]).symbol=">",this.at(o[0].getCenter()).symbol="☨";var h=this.landmarks.slice();this.player=new zt(zt.PLAYER);for(var c=0;c<h.length;c++){var d=h[c];if(d[0]>5&&d[0]<this.options.size[0]-5&&d[1]>5&&d[1]<this.options.size[1]-5){this.player.at=h[c].slice(),h.splice(c,1);break}}this.addHut();t:for(c=0;c<this.options.flowers;c++)for(;h.length>0;){var u=h.pop();if(" "==this.at(u).symbol){this.at(u).symbol="⚘";continue t}}this.player.lookAround();t:for(c=0;c<this.options.mobs;c++){for(var f=new zt;h.length>0;){u=h.pop();var p=this.at(u);if(" "==p.symbol&&!p.seen){f.at=u.slice();continue t}}f.at||Jt.mobs.pop()}this.pathfinder.setGrid(),Jt.log(ee.guide),Jt.log(ee.not_here)},t.prototype.tileBg=function(t){var e=this.safeAt(t),i=[0,0,0],n=oe(t,this.player.at)<10+Math.max(Math.min(this.player.concentration,10),.1*this.player.hate);if(!(e.seen||n&&0!=e.scent))return Lt.toRGB(this.hateBg);if(e.visible){var s=48*e.visible;i=[s,s,s]}return e.scent>0&&(i=Lt.add(i,[128*(n?e.scent:0),0,0]),e.seen=1),Lt.toRGB(i)},t.prototype.tileFg=function(t){var e=this.safeAt(t);if(e.mob&&e.visible)return e.mob.fg();if(!e.mob&&e.seen&&"♠"==e.symbol){z.setSeed(1e3*t[0]+3*t[1]);var i=z.getUniformInt(150,250);return Lt.toRGB([i,i,i])}return"b"==e.symbol||"B"==e.symbol?"#800":e.symbol.match(/[ ♠#_]/)?null:"red"},t.prototype.tileSym=function(t){var e=this.safeAt(t);return e.mob&&e.visible?e.mob.sym():e.visible||e.seen?"♠"==e.symbol?(z.setSeed(1e3*t[0]+3*t[1]),z.getItem(["♠","♣"])):"b"==e.symbol||"B"==e.symbol?"*":"s"==e.symbol?e.visible&&Jt.allFlowersCollected()&&this.flowersCollected%2==1?"s":" ":e.symbol:" "},t.prototype.deltaAndHalf=function(){var t=this,e=[0,1].map(function(e){return Math.floor(t.displaySize[e]/2)});return{delta:[0,1].map(function(i){return-t.player.at[i]+e[i]}),half:e}},t.prototype.drawAt=function(t,e,i){var n;e||(e=this.deltaAndHalf().delta);var s,o,r=(o=e,[(s=t)[0]+o[0],s[1]+o[1]]),a=this.safeAt(t),l=[this.tileSym(t),this.tileFg(t),this.tileBg(t)],h=l[0],c=l[1],d=l[2];i&&(h=(n=i([h,c,d]))[0],c=n[1],d=n[2]),a==this.emptyTile?this.d.draw(r[0],r[1]," ",null,Lt.toRGB(this.hateBg)):this.d.draw(r[0],r[1],h,c,d)},t.prototype.draw=function(){this.hateBg=this.seeingRed?[255,0,0]:Lt.add(Qt,[.64*this.player.hate,0,0]);var t=Lt.toRGB(this.hateBg);this.d.setOptions({bg:t}),this.d.clear(),this.d.drawText(0,0,"%b{red}%c{red}"+"-".repeat(Math.round(this.player.hate*this.displaySize[0]/100))),document.documentElement.style.background=t;for(var e=this.deltaAndHalf(),i=e.delta,n=e.half,s=this.player.at[0]-n[0];s<this.player.at[0]+n[0]+1;s++)for(var o=this.player.at[1]-n[1]+1;o<this.player.at[1]+n[1];o++)this.drawAt([s,o],i);this.d.drawText(0,this.displaySize[1]-1,"%b{"+t+"}%c{"+t+"}"+" ".repeat(this.displaySize[0]));var r="";if(this.milestones.flower_first)for(var a=0;a<this.options.flowers;a++)r+=a<this.flowersCollected?"%c{red}⚘":"%c{gray}⚘";this.player.waiting()&&this.drawAt([this.player.at[0],this.player.at[1]-1],i,function(t){t[0],t[1];var e=t[2];return[[".","‥","…"][(new Date).getSeconds()%3],"white",e]}),this.milestones.mob_first_0&&(r+="%b{"+t+"}%c{gray} "+this.mobs.filter(function(t){return!t.isPlayer()&&(t.at||t.isGuard)}).map(function(t){return t.alive?"%c{"+t.fg()+"}"+t.sym():"%c{red}*"}).join("")),this.d.drawText(0,this.displaySize[1]-1,r)},t.prototype.onKeyboard=function(t){this.paused||(this.lastKey=t,zt.meansStop(t)&&this.player.stop(),this.waitingForInput&&this.playerAct())},t.prototype.displayToGrid=function(t){return de(t,this.deltaAndHalf().delta)},t.prototype.onClick=function(t){this.paused||(t.preventDefault(),this.click())},t.prototype.click=function(){if(Jt.player.hasPath())Jt.player.stop();else{var t=this.displayToGrid(this.mouseOver),e=this.safeAt(t);if(ue(t,Jt.player.at))Jt.player.path=[Jt.player.at.slice()];else{if(e.cost>1e3){var i=this.freeTiles.map(function(e){return{at:e,d:oe(e,t)}}).reduce(function(t,e){return e.d<t.d?e:t},{at:[0,0],d:1e6});if(oe(t,this.player.at)<i.d)return;t=i.at}Jt.player.setPath(t)}this.waitingForInput&&this.playerAct()}},t.prototype.allFlowersCollected=function(){return this.flowersCollected>=this.options.flowersNeeded},t.prototype.eachTile=function(t){for(var e=this.options.size,i=e[0],n=(e[1],0);n<i;n++)for(var s=0;s<i;s++)if(t([n,s],this.grid[n][s]))return},t.prototype.log=function(t){for(var e=this,i=[],n=1;n<arguments.length;n++)i[n-1]=arguments[n];t&&(this._log.push([t].concat(i)),console.log(t),console.log(this._log),Vt.update(function(t){return e._log}))},t.prototype.alertOnce=function(t){this.milestones[t]||(this.player.stop(),this.milestones[t]=1,"mob_first_4"==t&&Jt.killed>0?this.log(ee.elder_angry):this.log(t))},t.prototype.playerAct=function(){var t=this;if(this.player.alive){var e=this.player.playerAct();this.draw(),e&&(this.player.hasPath()||this.seeingRed||(this.autoSaved=!1),this.seeingRed||this.player.hasPath()?(this.waitingForInput=!1,window.setTimeout(function(){t.waitingForInput=!0,Jt.engine.unlock()},50)):Jt.engine.unlock())}},t.prototype.readNextLetter=function(){if(this.player.stop(),te.letter.length>=this.letterRead){var t=this.letterRead;te.read_letter[t]&&this.log("complete_letter_"+t),this.letterRead++}},t.prototype.end=function(t){if(this.complete=!0,this.paused=!0,!t){var e=z.getUniformInt(0,this.killed);console.log(e);var i=e<=1,n=this.flowersCollected%2==1;t=i?n?te.ending_bargain:te.ending_depression:n?te.ending_denial:te.ending_anger}this.onEnd(t)},t}(),ge=Bt(function(t){!function(){function e(t,e){document.addEventListener?t.addEventListener("scroll",e,!1):t.attachEvent("scroll",e)}function i(t){this.a=document.createElement("div"),this.a.setAttribute("aria-hidden","true"),this.a.appendChild(document.createTextNode(t)),this.b=document.createElement("span"),this.c=document.createElement("span"),this.h=document.createElement("span"),this.f=document.createElement("span"),this.g=-1,this.b.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.c.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.f.style.cssText="max-width:none;display:inline-block;position:absolute;height:100%;width:100%;overflow:scroll;font-size:16px;",this.h.style.cssText="display:inline-block;width:200%;height:200%;font-size:16px;max-width:none;",this.b.appendChild(this.h),this.c.appendChild(this.f),this.a.appendChild(this.b),this.a.appendChild(this.c)}function n(t,e){t.a.style.cssText="max-width:none;min-width:20px;min-height:20px;display:inline-block;overflow:hidden;position:absolute;width:auto;margin:0;padding:0;top:-999px;white-space:nowrap;font-synthesis:none;font:"+e+";"}function s(t){var e=t.a.offsetWidth,i=e+100;return t.f.style.width=i+"px",t.c.scrollLeft=i,t.b.scrollLeft=t.b.scrollWidth+100,t.g!==e&&(t.g=e,!0)}function o(t,i){function n(){var t=o;s(t)&&t.a.parentNode&&i(t.g)}var o=t;e(t.b,n),e(t.c,n),s(t)}function r(t,e){var i=e||{};this.family=t,this.style=i.style||"normal",this.weight=i.weight||"normal",this.stretch=i.stretch||"normal"}var a=null,l=null,h=null,c=null;function d(){return null===c&&(c=!!document.fonts),c}function u(){if(null===h){var t=document.createElement("div");try{t.style.font="condensed 100px sans-serif"}catch(t){}h=""!==t.style.font}return h}function f(t,e){return[t.style,t.weight,u()?t.stretch:"","100px",e].join(" ")}r.prototype.load=function(t,e){var s=this,r=t||"BESbswy",h=0,c=e||3e3,u=(new Date).getTime();return new Promise(function(t,e){if(d()&&!function(){if(null===l)if(d()&&/Apple/.test(window.navigator.vendor)){var t=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))(?:\.([0-9]+))/.exec(window.navigator.userAgent);l=!!t&&603>parseInt(t[1],10)}else l=!1;return l}()){var p=new Promise(function(t,e){!function i(){(new Date).getTime()-u>=c?e(Error(c+"ms timeout exceeded")):document.fonts.load(f(s,'"'+s.family+'"'),r).then(function(e){1<=e.length?t():setTimeout(i,25)},e)}()}),g=new Promise(function(t,e){h=setTimeout(function(){e(Error(c+"ms timeout exceeded"))},c)});Promise.race([g,p]).then(function(){clearTimeout(h),t(s)},e)}else!function(t){document.body?t():document.addEventListener?document.addEventListener("DOMContentLoaded",function e(){document.removeEventListener("DOMContentLoaded",e),t()}):document.attachEvent("onreadystatechange",function e(){"interactive"!=document.readyState&&"complete"!=document.readyState||(document.detachEvent("onreadystatechange",e),t())})}(function(){function l(){var e;(e=-1!=m&&-1!=_||-1!=m&&-1!=y||-1!=_&&-1!=y)&&((e=m!=_&&m!=y&&_!=y)||(null===a&&(e=/AppleWebKit\/([0-9]+)(?:\.([0-9]+))/.exec(window.navigator.userAgent),a=!!e&&(536>parseInt(e[1],10)||536===parseInt(e[1],10)&&11>=parseInt(e[2],10))),e=a&&(m==v&&_==v&&y==v||m==b&&_==b&&y==b||m==w&&_==w&&y==w)),e=!e),e&&(x.parentNode&&x.parentNode.removeChild(x),clearTimeout(h),t(s))}var d=new i(r),p=new i(r),g=new i(r),m=-1,_=-1,y=-1,v=-1,b=-1,w=-1,x=document.createElement("div");x.dir="ltr",n(d,f(s,"sans-serif")),n(p,f(s,"serif")),n(g,f(s,"monospace")),x.appendChild(d.a),x.appendChild(p.a),x.appendChild(g.a),document.body.appendChild(x),v=d.a.offsetWidth,b=p.a.offsetWidth,w=g.a.offsetWidth,function t(){if((new Date).getTime()-u>=c)x.parentNode&&x.parentNode.removeChild(x),e(Error(c+"ms timeout exceeded"));else{var i=document.hidden;!0!==i&&void 0!==i||(m=d.a.offsetWidth,_=p.a.offsetWidth,y=g.a.offsetWidth,l()),h=setTimeout(t,50)}}(),o(d,function(t){m=t,l()}),n(d,f(s,'"'+s.family+'",sans-serif')),o(p,function(t){_=t,l()}),n(p,f(s,'"'+s.family+'",serif')),o(g,function(t){y=t,l()}),n(g,f(s,'"'+s.family+'",monospace'))})})},t.exports=r}()});function me(t,e,i){const n=Object.create(t);return n.record=e[i],n}function _e(t,e,i){const n=Object.create(t);return n.slot=e[i],n}function ye(t){for(var e,i,n,o,r,_,y,v,b,w,x,k,T,S,I,E,M=t.lang.new_game,A=t.lang.lang,C=t.game&&t.game.time>0&&!t.game.complete&&be(t),P=[1,2,3,4,5,6,7,8,9],O=[],R=0;R<9;R+=1)O[R]=we(_e(t,P,R));return{c(){(e=d("h1")).textContent="Seeing Red",i=f(),n=d("div"),o=d("div"),r=d("div"),_=d("button"),y=u(M),v=f(),C&&C.c(),b=f(),w=d("div"),x=f(),k=d("button"),T=u(A),S=f(),I=d("div");for(var s=0;s<9;s+=1)O[s].c();m(w,"flex-grow","1"),r.className="menu-buttons",I.className="saves",o.className="menu-table",E=[p(_,"click",t.click_handler_1),p(k,"click",ne)]},m(t,s){l(t,e,s),l(t,i,s),l(t,n,s),a(n,o),a(o,r),a(r,_),a(_,y),a(r,v),C&&C.m(r,null),a(r,b),a(r,w),a(r,x),a(r,k),a(k,T),a(o,S),a(o,I);for(var h=0;h<9;h+=1)O[h].m(I,null)},p(t,e){if(t.lang&&M!==(M=e.lang.new_game)&&g(y,M),e.game&&e.game.time>0&&!e.game.complete?C?C.p(t,e):((C=be(e)).c(),C.m(r,b)):C&&(C.d(1),C=null),t.lang&&A!==(A=e.lang.lang)&&g(T,A),t.game||t.lang){P=[1,2,3,4,5,6,7,8,9];for(var i=0;i<P.length;i+=1){const n=_e(e,P,i);O[i]?O[i].p(t,n):(O[i]=we(n),O[i].c(),O[i].m(I,null))}for(;i<9;i+=1)O[i].d(1)}},d(t){t&&(h(e),h(i),h(n)),C&&C.d(),c(O,t),s(E)}}}function ve(t){var e,i,n,s,o,r,c,_,y,v=t.lang.continue,b=t.lang.win_tip;return{c(){e=d("div"),i=d("noscript"),n=f(),s=d("div"),o=d("button"),r=u(v),c=f(),_=d("div"),m(s,"text-align","center"),_.className="win-tip",e.className="win",e.id="win",y=p(o,"click",t.click_handler)},m(h,d){l(h,e,d),a(e,i),i.insertAdjacentHTML("beforebegin",t.winText),a(e,n),a(e,s),a(s,o),a(o,r),a(e,c),a(e,_),_.innerHTML=b,E(()=>t.div2_binding(e,null))},p(t,n){t.winText&&(!function(t){for(;t.previousSibling;)t.parentNode.removeChild(t.previousSibling)}(i),i.insertAdjacentHTML("beforebegin",n.winText)),t.lang&&v!==(v=n.lang.continue)&&g(r,v),t.lang&&b!==(b=n.lang.win_tip)&&(_.innerHTML=b),t.items&&(n.div2_binding(null,e),n.div2_binding(e,null))},d(i){i&&h(e),t.div2_binding(null,e),y()}}}function be(t){var e,i,n,s=t.lang.continue;return{c(){e=d("button"),i=u(s),n=p(e,"click",t.click_handler_2)},m(t,n){l(t,e,n),a(e,i)},p(t,e){t.lang&&s!==(s=e.lang.continue)&&g(i,s)},d(t){t&&h(e),n()}}}function we(t){var e,i,n,o,r,c,m,_,y,v,b,w=t.lang.save,x=t.lang.load;function k(){return t.click_handler_3(t)}function T(){return t.click_handler_4(t)}return{c(){e=d("div"),i=u(t.slot),n=u(".\r\n                "),o=d("button"),r=u(w),m=f(),_=d("button"),y=u(x),o.disabled=c=!t.game||0==t.game.time,_.disabled=v=!t.game||!t.game.hasSave(t.slot),e.className="save",b=[p(o,"click",k),p(_,"click",T)]},m(t,s){l(t,e,s),a(e,i),a(e,n),a(e,o),a(o,r),a(e,m),a(e,_),a(_,y)},p(e,i){t=i,e.lang&&w!==(w=t.lang.save)&&g(r,w),e.game&&c!==(c=!t.game||0==t.game.time)&&(o.disabled=c),e.lang&&x!==(x=t.lang.load)&&g(y,x),e.game&&v!==(v=!t.game||!t.game.hasSave(t.slot))&&(_.disabled=v)},d(t){t&&h(e),s(b)}}}function xe(t){for(var e,i,n=t.translated(t.log[t.log.length-1]).substr(0,t.lettersLogged),s=t.log.slice(0,t.log.length-1),o=[],r=0;r<s.length;r+=1)o[r]=ke(me(t,s,r));return{c(){for(var t=0;t<o.length;t+=1)o[t].c();e=f(),(i=d("div")).className="record"},m(t,s){for(var r=0;r<o.length;r+=1)o[r].m(t,s);l(t,e,s),l(t,i,s),i.innerHTML=n},p(t,r){if(t.translated||t.log){s=r.log.slice(0,r.log.length-1);for(var a=0;a<s.length;a+=1){const i=me(r,s,a);o[a]?o[a].p(t,i):(o[a]=ke(i),o[a].c(),o[a].m(e.parentNode,e))}for(;a<o.length;a+=1)o[a].d(1);o.length=s.length}(t.log||t.lettersLogged)&&n!==(n=r.translated(r.log[r.log.length-1]).substr(0,r.lettersLogged))&&(i.innerHTML=n)},d(t){c(o,t),t&&(h(e),h(i))}}}function ke(t){var e,i=t.translated(t.record);return{c(){(e=d("div")).className="record"},m(t,n){l(t,e,n),e.innerHTML=i},p(t,n){t.log&&i!==(i=n.translated(n.record))&&(e.innerHTML=i)},d(t){t&&h(e)}}}function Te(t){var i,n,s,o,r,c,u,g,m,_,y;function v(t){return t.winText?ve:ye}var b=v(t),w=b(t),x=t.log.length>0&&xe(t);return{c(){(i=d("div")).textContent="Tooltip",n=f(),s=d("div"),o=d("div"),w.c(),r=f(),c=d("div"),u=d("div"),g=d("div"),m=f(),_=d("div"),x&&x.c(),i.className="tooltip fadein",o.className="menu",g.className="game",g.id="game",_.className="log",u.className="main-table",c.className="mainer-table",s.className="all",y=p(g,"contextmenu",Ie)},m(e,h){l(e,i,h),E(()=>t.div0_binding(i,null)),l(e,n,h),l(e,s,h),a(s,o),w.m(o,null),E(()=>t.div1_binding(o,null)),a(s,r),a(s,c),a(c,u),a(u,g),E(()=>t.div2_binding_1(g,null)),a(u,m),a(u,_),x&&x.m(_,null),E(()=>t.div3_binding(_,null))},p(t,e){t.items&&(e.div0_binding(null,i),e.div0_binding(i,null)),b===(b=v(e))&&w?w.p(t,e):(w.d(1),(w=b(e))&&(w.c(),w.m(o,null))),t.items&&(e.div1_binding(null,o),e.div1_binding(o,null)),t.items&&(e.div2_binding_1(null,g),e.div2_binding_1(g,null)),e.log.length>0?x?x.p(t,e):((x=xe(e)).c(),x.m(_,null)):x&&(x.d(1),x=null),t.items&&(e.div3_binding(null,_),e.div3_binding(_,null))},i:e,o:e,d(e){e&&h(i),t.div0_binding(null,i),e&&(h(n),h(s)),w.d(),t.div1_binding(null,o),t.div2_binding_1(null,g),x&&x.d(),t.div3_binding(null,_),y()}}}let Se=/[?&]([^=#]+)=([^&#]*)/g;function Ie(t){return t.preventDefault()}function Ee(t,e,i){let n,s,o,r,a,l,h,c,d,u,f=new ge("Icons"),p={},g=(location.hash,window.location.href),m=0,_=!1;function y(t){let e=u[t[0]];if(!e)return"-";if(t.length>0)for(let i in t)e=e.replace("{"+(i-1)+"}",t[i]);return e}for(Vt.subscribe(t=>{i("log",d=t),i("lettersLogged",m=0),r&&(r.scrollTop=1e6,i("gameLog",r))}),Kt.subscribe(t=>{i("lang",u=t),i("log",d)});n=Se.exec(g);)try{p[n[1]]=JSON.parse(n[2])}catch(t){console.log("what is "+n[1]+"?")}function b(t){h.innerHTML=t,i("tooltip",h);let e=h.classList;t?e.add("visible"):e.remove("visible")}function x(t){_=t,s.paused=t,i("game",s),a.style.opacity=t?1:0,i("menuDiv",a),a.style["pointer-events"]=t?"auto":"none",i("menuDiv",a),t&&b(null),t||i("winText",c=null)}function k(t){s.save(t),x(!1)}function T(t){s.load(t),x(!1)}function S(){s.start(p),x(!1)}async function E(t){x(!0),i("winText",c=t),await(I(),w),l.style.opacity=0,i("winDiv",l),window.setTimeout(()=>{const t=l.style.opacity=1;return i("winDiv",l),t},100),s.start(p)}return f.load().then(()=>{i("game",s=new pe),s.onEnd=E,i("game",s),s.init([45,45]),s.hasSave("0")?s.load("0"):s.start(p),r.style.height=o.clientHeight+"px",i("gameLog",r),x(!0)}),v(async()=>{setInterval(()=>{if(d&&d.length>0){let t=y(d[d.length-1]);t&&m<t.length&&(i("lettersLogged",m=Math.ceil((t.length-m)/40)+m),r.scrollTop=r.scrollHeight,i("gameLog",r))}},10)}),window.addEventListener("mousemove",async t=>{_||(Math.abs(t.movementY)+Math.abs(t.movementX)>2&&(b(null),await function(t){return new Promise(e=>setTimeout(e,t))}(30)),h&&(h.style.left=t.clientX+"px",i("tooltip",h),h.style.top=t.clientY+"px",i("tooltip",h),s&&b(s.tooltip)))}),window.addEventListener("keydown",t=>{if("Escape"==t.code&&(c?i("winText",c=null):x(!_)),t.shiftKey&&"KeyR"==t.code&&(s.start(),x(!1)),t.shiftKey&&"KeyL"==t.code&&ne(),"Digit"==t.code.substr(0,5)){let e=t.code.substr(5);t.shiftKey?(s.save(e),x(!1)):s.hasSave(e)?(s.load(e),x(!1)):s.log("no_save_in",e)}}),{game:s,gameDiv:o,gameLog:r,menuDiv:a,winDiv:l,tooltip:h,lettersLogged:m,winText:c,log:d,lang:u,translated:y,toggleMenu:x,save:k,load:T,newGame:S,div0_binding:function(t,e){i("tooltip",h=t)},click_handler:function(){const t=c=null;return i("winText",c),t},div2_binding:function(t,e){i("winDiv",l=t)},click_handler_1:function(){return S()},click_handler_2:function(){return x(!1)},click_handler_3:function({slot:t}){return k(t)},click_handler_4:function({slot:t}){return T(t)},div1_binding:function(t,e){i("menuDiv",a=t)},div2_binding_1:function(t,e){i("gameDiv",o=t)},div3_binding:function(t,e){i("gameLog",r=t)}}}class Me extends O{constructor(t){super(),P(this,t,Ee,Te,r,[])}}return window.onload=function(){t.ui=new Me({target:document.body})},t.default=app,t}({});
